<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€¥è¨ºé†«ç™‚æœå‹™è«‹æ±‚ç³»çµ± - FHIR ä»‹é¢</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f0f4f8;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1a5f7a, #2a9d8f);
            color: white;
            padding: 20px 30px;
        }
        
        h1 {
            margin-bottom: 8px;
            font-size: 28px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .organization-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .org-info {
            flex: 1;
            min-width: 200px;
        }
        
        .org-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .org-id {
            font-size: 14px;
            opacity: 0.9;
            font-family: monospace;
        }
        
        .org-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .org-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .org-btn-primary {
            background-color: #2a9d8f;
            color: white;
        }
        
        .org-btn-primary:hover {
            background-color: #23857a;
        }
        
        .org-btn-secondary {
            background-color: #4299e1;
            color: white;
        }
        
        .org-btn-secondary:hover {
            background-color: #3182ce;
        }
        
        .org-select-group {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }
        
        .org-select-group select {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 0;
        }
        
        .sidebar {
            flex: 0 0 380px;
            background-color: #f8fafc;
            border-right: 1px solid #e2e8f0;
            padding: 25px;
        }
        
        .main-panel {
            flex: 1;
            padding: 25px;
            min-width: 300px;
        }
        
        .panel-title {
            font-size: 20px;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .form-section {
            margin-bottom: 25px;
        }
        
        .form-section h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #4a5568;
            font-size: 15px;
        }
        
        .required::after {
            content: " *";
            color: #e53e3e;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
            background-color: white;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .radio-option input {
            width: auto;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 30px;
        }
        
        button {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            min-width: 140px;
        }
        
        button i {
            font-size: 18px;
        }
        
        .btn-primary {
            background-color: #2a9d8f;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #23857a;
        }
        
        .btn-secondary {
            background-color: #4299e1;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #3182ce;
        }
        
        .btn-danger {
            background-color: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #e53e3e;
        }
        
        .btn-warning {
            background-color: #ed8936;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #dd6b20;
        }
        
        .btn-success {
            background-color: #38a169;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #2f855a;
        }
        
        .btn-info {
            background-color: #0bc5ea;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #00a3c4;
        }
        
        .btn-purple {
            background-color: #9f7aea;
            color: white;
        }
        
        .btn-purple:hover {
            background-color: #805ad5;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 25px;
            font-weight: 600;
            display: none;
        }
        
        .status-success {
            background-color: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #38a169;
            display: block;
        }
        
        .status-error {
            background-color: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #e53e3e;
            display: block;
        }
        
        .status-info {
            background-color: #bee3f8;
            color: #2a4365;
            border-left: 4px solid #4299e1;
            display: block;
        }
        
        .status-warning {
            background-color: #feebc8;
            color: #744210;
            border-left: 4px solid #ed8936;
            display: block;
        }
        
        .result-section {
            margin-top: 30px;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .result-content {
            background-color: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            line-height: 1.5;
        }
        
        .json-view-toggle {
            display: flex;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            overflow: hidden;
            width: fit-content;
        }
        
        .json-view-toggle button {
            padding: 8px 16px;
            border-radius: 0;
            border: none;
            background-color: #f7fafc;
            color: #4a5568;
            font-size: 14px;
            min-width: auto;
        }
        
        .json-view-toggle button.active {
            background-color: #4299e1;
            color: white;
        }
        
        .mode-selector {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .mode-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #718096;
            font-weight: 600;
            cursor: pointer;
            min-width: auto;
            border-radius: 0;
        }
        
        .mode-tab.active {
            color: #2a9d8f;
            border-bottom-color: #2a9d8f;
            background-color: rgba(42, 157, 143, 0.05);
        }
        
        .hidden {
            display: none;
        }
        
        .emergency-badge {
            display: inline-block;
            background-color: #fed7d7;
            color: #c53030;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .patient-info {
            background-color: #ebf8ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4299e1;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 8px;
        }
        
        .info-label {
            font-weight: 600;
            width: 120px;
            color: #4a5568;
        }
        
        .info-value {
            color: #2d3748;
        }
        
        .practitioner-info {
            background-color: #f0fff4;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #38a169;
        }
        
        .practitioner-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .inline-form-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .inline-form-group .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .inline-button {
            padding: 12px 20px;
            min-width: auto;
            flex: 0 0 auto;
        }
        
        .request-management {
            background-color: #fff5f5;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            border-left: 4px solid #f56565;
        }
        
        .history-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .history-filter .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .request-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: white;
            border-left: 4px solid #4299e1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        
        .request-item.selected {
            background-color: #fef3c7;
            border-left: 4px solid #ed8936;
        }
        
        .request-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .request-id {
            font-weight: bold;
            color: #2d3748;
        }
        
        .request-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background-color: #c6f6d5;
            color: #22543d;
        }
        
        .status-completed {
            background-color: #bee3f8;
            color: #2a4365;
        }
        
        .status-cancelled {
            background-color: #fed7d7;
            color: #742a2a;
        }
        
        .request-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 2px;
        }
        
        .detail-value {
            font-size: 14px;
            color: #2d3748;
            font-weight: 500;
        }
        
        .request-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        
        .organization-badge {
            display: inline-block;
            background-color: #e9d8fd;
            color: #553c9a;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            margin-top: 10px;
            background-color: white;
        }
        
        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #f7fafc;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-name {
            font-weight: 600;
            color: #2d3748;
        }
        
        .search-result-id {
            font-size: 12px;
            color: #718096;
        }
        
        .new-patient-form {
            background-color: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e2e8f0;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .dropdown-search {
            position: relative;
        }
        
        .dropdown-search input {
            width: 100%;
            padding-right: 40px;
        }
        
        .dropdown-search .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
        }
        
        .dropdown-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #cbd5e0;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        
        .dropdown-results.active {
            display: block;
        }
        
        .dropdown-results .search-result-item {
            border-bottom: 1px solid #e2e8f0;
        }
        
        .dropdown-results .search-result-item:last-child {
            border-bottom: none;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            color: #718096;
            font-size: 14px;
            background-color: #f8fafc;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
            min-width: auto;
        }
        
        .selected-count {
            display: inline-block;
            background-color: #ed8936;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .function-explanation {
            background-color: #ebf8ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #4299e1;
        }
        
        .function-explanation h4 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .function-explanation ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .function-explanation li {
            margin-bottom: 8px;
            color: #4a5568;
        }
        
        .function-explanation .highlight {
            background-color: #fef3c7;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* åˆ†é æ¨£å¼ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .pagination-button {
            padding: 8px 16px;
            border: 1px solid #cbd5e0;
            background-color: white;
            color: #4a5568;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .pagination-button:hover {
            background-color: #edf2f7;
        }
        
        .pagination-button.active {
            background-color: #4299e1;
            color: white;
            border-color: #4299e1;
        }
        
        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-info {
            font-size: 14px;
            color: #718096;
            margin: 0 10px;
        }
        
        .no-requests {
            text-align: center;
            padding: 30px;
            color: #718096;
            font-size: 16px;
            background-color: #f7fafc;
            border-radius: 8px;
            border: 1px dashed #cbd5e0;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .inline-form-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .inline-button {
                width: 100%;
            }
            
            .history-filter {
                flex-direction: column;
            }
            
            .request-details {
                grid-template-columns: 1fr;
            }
            
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .org-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .org-btn {
                width: 100%;
            }
            
            .pagination {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>æ€¥è¨ºé†«ç™‚æœå‹™è«‹æ±‚ç³»çµ± <span class="emergency-badge">FHIR ä»‹é¢</span></h1>
            <p class="subtitle">ç°¡åŒ– FHIR è³‡æºæ“ä½œï¼Œå°ˆç‚ºé†«ç™‚äººå“¡è¨­è¨ˆ</p>
            
            <div class="organization-controls">
                <div class="org-info">
                    <div class="org-name" id="currentOrgName">æœªé¸æ“‡çµ„ç¹”</div>
                    <div class="org-id" id="currentOrgId">çµ„ç¹”ID: æœªè¨­å®š</div>
                </div>
                <div class="org-buttons">
                    <button class="org-btn org-btn-primary" id="btnAutoCreateOrg">
                        <i class="fas fa-plus-circle"></i> è‡ªå‹•ç”Ÿæˆçµ„ç¹”
                    </button>
                    <button class="org-btn org-btn-secondary" id="btnSearchOrgs">
                        <i class="fas fa-search"></i> æœå°‹çµ„ç¹”
                    </button>
                </div>
                
                <div class="org-select-group" id="orgSelectGroup" style="display: none;">
                    <select id="orgSelect">
                        <option value="">-- é¸æ“‡ç¾æœ‰çµ„ç¹” --</option>
                    </select>
                    <button class="org-btn org-btn-secondary" id="btnLoadOrg">
                        <i class="fas fa-check"></i> è¼‰å…¥
                    </button>
                </div>
            </div>
        </header>
        
        <div class="content">
            <div class="sidebar">
                <h2 class="panel-title">æ“ä½œæ§åˆ¶</h2>
                
                <div class="mode-selector">
                    <button class="mode-tab active" id="tabForm">è¡¨å–®æ¨¡å¼</button>
                    <button class="mode-tab" id="tabJson">JSON æ¨¡å¼</button>
                </div>
                
                <div id="formMode">
                    <div class="form-section">
                        <h3>ç—…æ‚£è³‡è¨Š</h3>
                        <div class="patient-info">
                            <div class="info-row">
                                <div class="info-label">ç—…æ‚£ ID:</div>
                                <div class="info-value" id="currentPatientId">æœªé¸æ“‡</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">ç—…æ‚£å§“å:</div>
                                <div class="info-value" id="currentPatientName">æœªé¸æ“‡</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">ç‹€æ…‹:</div>
                                <div class="info-value" id="patientStatus">æœªé©—è­‰</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="patientSelect" class="required">é¸æ“‡ç—…æ‚£</label>
                            <select id="patientSelect">
                                <option value="">-- è«‹é¸æ“‡ç—…æ‚£ --</option>
                                <option value="search-patient">æœå°‹ç—…æ‚£...</option>
                                <option value="new-patient">æ–°å¢ç—…æ‚£...</option>
                            </select>
                        </div>
                        
                        <!-- æœå°‹ç—…æ‚£å€åŸŸ -->
                        <div class="form-group" id="searchPatientGroup" style="display: none;">
                            <label for="patientSearchSelect">æœå°‹ç—…æ‚£</label>
                            <select id="patientSearchSelect">
                                <option value="">-- è«‹é¸æ“‡ç—…æ‚£ --</option>
                            </select>
                            <div class="button-group" style="margin-top: 10px;">
                                <button class="btn-secondary" id="btnSearchAllPatients">
                                    <i class="fas fa-sync-alt"></i> é‡æ–°è¼‰å…¥ç—…æ‚£åˆ—è¡¨
                                </button>
                            </div>
                        </div>
                        
                        <!-- æ–°å¢ç—…æ‚£å€åŸŸ -->
                        <div class="new-patient-form" id="newPatientForm" style="display: none;">
                            <h4>æ–°å¢ç—…æ‚£è³‡è¨Š</h4>
                            <div class="two-column">
                                <div class="form-group">
                                    <label for="newPatientLastName" class="required">å§“</label>
                                    <input type="text" id="newPatientLastName" placeholder="ç‹">
                                </div>
                                <div class="form-group">
                                    <label for="newPatientFirstName" class="required">å</label>
                                    <input type="text" id="newPatientFirstName" placeholder="å¤§æ˜">
                                </div>
                            </div>
                            
                            <div class="two-column">
                                <div class="form-group">
                                    <label for="newPatientGender" class="required">æ€§åˆ¥</label>
                                    <select id="newPatientGender">
                                        <option value="male">ç”·</option>
                                        <option value="female">å¥³</option>
                                        <option value="other">å…¶ä»–</option>
                                        <option value="unknown">æœªçŸ¥</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="newPatientBirthDate">å‡ºç”Ÿæ—¥æœŸ</label>
                                    <input type="date" id="newPatientBirthDate">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="newPatientId">ç—…æ‚£ ID (é¸å¡«)</label>
                                <input type="text" id="newPatientId" placeholder="ç•™ç©ºå‰‡è‡ªå‹•ç”¢ç”Ÿ">
                            </div>
                            
                            <button class="btn-success" id="btnCreatePatient" style="width: 100%;">
                                <i class="fas fa-user-plus"></i> å»ºç«‹ç—…æ‚£è³‡æº
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>æœå‹™è«‹æ±‚å…§å®¹</h3>
                        
                        <div class="form-group">
                            <label for="serviceType" class="required">æœå‹™é¡å‹</label>
                            <select id="serviceType">
                                <option value="">-- è«‹é¸æ“‡æœå‹™é¡å‹ --</option>
                                <option value="lab-blood">è¡€æ¶²æª¢é©—</option>
                                <option value="lab-urine">å°¿æ¶²æª¢é©—</option>
                                <option value="imaging-xray">X å…‰æª¢æŸ¥</option>
                                <option value="imaging-ultrasound">è¶…éŸ³æ³¢æª¢æŸ¥</option>
                                <option value="imaging-ct">é›»è…¦æ–·å±¤æƒæ</option>
                                <option value="consultation">å°ˆç§‘æœƒè¨º</option>
                                <option value="procedure">è™•ç½®/æ‰‹è¡“</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="priority" class="required">å„ªå…ˆç­‰ç´š</label>
                            <select id="priority">
                                <option value="routine">å¸¸è¦ (routine)</option>
                                <option value="urgent">ç·Šæ€¥ (urgent)</option>
                                <option value="stat" selected>æœ€å„ªå…ˆ (stat)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="clinicalNote">è‡¨åºŠè¨»è¨˜</label>
                            <textarea id="clinicalNote" rows="3" placeholder="è¼¸å…¥è‡¨åºŠç‹€æ³æˆ–ç‰¹æ®Šéœ€æ±‚..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-section practitioner-section">
                        <h3>é†«å¸«è³‡è¨Š</h3>
                        <div class="practitioner-info">
                            <div class="info-row">
                                <div class="info-label">é†«å¸« ID:</div>
                                <div class="info-value" id="currentPractitionerId">æœªé¸æ“‡</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">é†«å¸«å§“å:</div>
                                <div class="info-value" id="currentPractitionerName">æœªé¸æ“‡</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">ç‹€æ…‹:</div>
                                <div class="info-value" id="practitionerStatus">æœªé©—è­‰</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="practitionerSelect" class="required">é¸æ“‡é†«å¸«</label>
                            <select id="practitionerSelect">
                                <option value="">-- è«‹é¸æ“‡é†«å¸« --</option>
                                <option value="search-practitioner">æœå°‹é†«å¸«...</option>
                                <option value="new-practitioner">æ–°å¢é†«å¸«...</option>
                            </select>
                        </div>
                        
                        <!-- æœå°‹é†«å¸«å€åŸŸ -->
                        <div class="form-group" id="searchPractitionerGroup" style="display: none;">
                            <label for="practitionerSearchSelect">æœå°‹é†«å¸«</label>
                            <select id="practitionerSearchSelect">
                                <option value="">-- è«‹é¸æ“‡é†«å¸« --</option>
                            </select>
                            <div class="button-group" style="margin-top: 10px;">
                                <button class="btn-secondary" id="btnSearchAllPractitioners">
                                    <i class="fas fa-sync-alt"></i> é‡æ–°è¼‰å…¥é†«å¸«åˆ—è¡¨
                                </button>
                            </div>
                        </div>
                        
                        <!-- æ–°å¢é†«å¸«å€åŸŸ -->
                        <div class="new-patient-form" id="newPractitionerForm" style="display: none;">
                            <h4>æ–°å¢é†«å¸«è³‡è¨Š</h4>
                            <div class="two-column">
                                <div class="form-group">
                                    <label for="newPractitionerLastName" class="required">å§“</label>
                                    <input type="text" id="newPractitionerLastName" placeholder="æ">
                                </div>
                                <div class="form-group">
                                    <label for="newPractitionerFirstName" class="required">å</label>
                                    <input type="text" id="newPractitionerFirstName" placeholder="é†«å¸«">
                                </div>
                            </div>
                            
                            <div class="two-column">
                                <div class="form-group">
                                    <label for="newPractitionerGender">æ€§åˆ¥</label>
                                    <select id="newPractitionerGender">
                                        <option value="male">ç”·</option>
                                        <option value="female">å¥³</option>
                                        <option value="other">å…¶ä»–</option>
                                        <option value="unknown">æœªçŸ¥</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="newPractitionerSpecialty">å°ˆç§‘</label>
                                    <select id="newPractitionerSpecialty">
                                        <option value="emergency">æ€¥è¨ºé†«å­¸</option>
                                        <option value="internal">å…§ç§‘</option>
                                        <option value="surgery">å¤–ç§‘</option>
                                        <option value="pediatrics">å°å…’ç§‘</option>
                                        <option value="radiology">æ”¾å°„ç§‘</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="newPractitionerId">é†«å¸« ID (é¸å¡«)</label>
                                <input type="text" id="newPractitionerId" placeholder="ç•™ç©ºå‰‡è‡ªå‹•ç”¢ç”Ÿ">
                            </div>
                            
                            <button class="btn-success" id="btnCreatePractitioner" style="width: 100%;">
                                <i class="fas fa-user-md"></i> å»ºç«‹é†«å¸«è³‡æº
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>è«‹æ±‚æ“ä½œ</h3>
                        
                        <div class="form-group">
                            <label>æ“ä½œé¡å‹</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="opCreate" name="operation" value="create" checked>
                                    <label for="opCreate">å»ºç«‹æ–°è«‹æ±‚</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="opUpdate" name="operation" value="update">
                                    <label for="opUpdate">æ›´æ–°è«‹æ±‚</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" id="requestIdGroup" style="display: none;">
                            <label for="requestSelect" class="required">é¸æ“‡è«‹æ±‚</label>
                            <select id="requestSelect">
                                <option value="">-- è«‹é¸æ“‡è¦æ›´æ–°çš„è«‹æ±‚ --</option>
                                <option value="search-request">æœå°‹æˆ‘çš„è«‹æ±‚...</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="searchRequestGroup" style="display: none;">
                            <button class="btn-secondary" id="btnLoadMyRequests" style="width: 100%;">
                                <i class="fas fa-search"></i> è¼‰å…¥æˆ‘çš„è«‹æ±‚
                            </button>
                            <div id="requestSearchResults" class="search-results" style="max-height: 150px;"></div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-primary" id="btnSubmit">
                            <i class="fas fa-paper-plane"></i> æäº¤è«‹æ±‚
                        </button>
                        <button class="btn-info" id="btnLoadEmergency">
                            <i class="fas fa-ambulance"></i> æ€¥è¨ºç¯„ä¾‹
                        </button>
                    </div>
                    
                    <div id="statusMessage" class="status-message"></div>
                </div>
                
                <div id="jsonMode" class="hidden">
                    <div class="form-section">
                        <h3>JSON è³‡æ–™</h3>
                        <div class="form-group">
                            <label for="resourceType">è³‡æºé¡å‹</label>
                            <select id="resourceType">
                                <option value="ServiceRequest">ServiceRequest</option>
                                <option value="Practitioner">Practitioner</option>
                                <option value="PractitionerRole">PractitionerRole</option>
                                <option value="Patient">Patient</option>
                                <option value="Organization">Organization</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="resourceId">è³‡æº ID (é¸å¡«)</label>
                            <input type="text" id="resourceId" placeholder="ç•™ç©ºå‰‡å»ºç«‹æ–°è³‡æº">
                        </div>
                        
                        <div class="form-group">
                            <label for="resourceJson">FHIR JSON å…§å®¹</label>
                            <textarea id="resourceJson" rows="12" placeholder="è²¼ä¸Šæˆ–ç·¨è¼¯ FHIR JSON è³‡æº..."></textarea>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn-primary" id="btnJsonCreate">
                                <i class="fas fa-plus"></i> å»ºç«‹
                            </button>
                            <button class="btn-secondary" id="btnJsonRead">
                                <i class="fas fa-search"></i> è®€å–
                            </button>
                            <button class="btn-warning" id="btnJsonUpdate">
                                <i class="fas fa-edit"></i> æ›´æ–°
                            </button>
                            <button class="btn-danger" id="btnJsonDelete">
                                <i class="fas fa-trash"></i> åˆªé™¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="main-panel">
                <h2 class="panel-title">è«‹æ±‚ç®¡ç† <span id="selectedCountBadge" class="selected-count" style="display: none;">å·²é¸ 0</span></h2>
                
                <div class="function-explanation">
                    <h4>ğŸ“‹ è«‹æ±‚ç®¡ç†åŠŸèƒ½èªªæ˜</h4>
                    <ul>
                        <li><span class="highlight">æŸ¥è©¢è«‹æ±‚</span>ï¼šæ ¹æ“šç¯©é¸æ¢ä»¶æŸ¥è©¢ç•¶å‰çµ„ç¹”çš„æœå‹™è«‹æ±‚</li>
                        <li><span class="highlight">åˆªé™¤é¸ä¸­è«‹æ±‚</span>ï¼šæ‰¹é‡åˆªé™¤å·²æ¨™è¨˜çš„è«‹æ±‚ï¼ˆæ°¸ä¹…åˆªé™¤ï¼‰</li>
                        <li><span class="highlight">æŸ¥çœ‹</span>ï¼šæŸ¥çœ‹è«‹æ±‚çš„è©³ç´°FHIR JSONè³‡æ–™</li>
                        <li><span class="highlight">æ›´æ–°</span>ï¼šå°‡è«‹æ±‚è¼‰å…¥åˆ°å·¦å´è¡¨å–®é€²è¡Œä¿®æ”¹</li>
                        <li><span class="highlight">é¸æ“‡</span>ï¼šæ¨™è¨˜è«‹æ±‚ä»¥ä¾¿é€²è¡Œæ‰¹é‡åˆªé™¤æ“ä½œ</li>
                    </ul>
                    <p><strong>ä½¿ç”¨æµç¨‹</strong>ï¼šå…ˆæ¨™è¨˜è«‹æ±‚ â†’ å†é€²è¡Œæ‰¹é‡åˆªé™¤</p>
                </div>
                
                <div class="request-management">
                    <h3>æŸ¥è©¢èˆ‡ç®¡ç†è«‹æ±‚</h3>
                    
                    <div class="history-filter">
                        <div class="form-group">
                            <label for="filterPractitioner">é†«å¸«</label>
                            <select id="filterPractitioner">
                                <option value="">æ‰€æœ‰é†«å¸«</option>
                                <option value="current">ç›®å‰é¸æ“‡çš„é†«å¸«</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="filterPatient">ç—…æ‚£</label>
                            <select id="filterPatient">
                                <option value="">æ‰€æœ‰ç—…æ‚£</option>
                                <option value="current">ç›®å‰é¸æ“‡çš„ç—…æ‚£</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="filterStatus">ç‹€æ…‹</label>
                            <select id="filterStatus">
                                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                                <option value="active">é€²è¡Œä¸­</option>
                                <option value="completed">å·²å®Œæˆ</option>
                                <option value="cancelled">å·²å–æ¶ˆ</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="filterPriority">å„ªå…ˆç´š</label>
                            <select id="filterPriority">
                                <option value="">æ‰€æœ‰å„ªå…ˆç´š</option>
                                <option value="routine">å¸¸è¦</option>
                                <option value="urgent">ç·Šæ€¥</option>
                                <option value="stat">æœ€å„ªå…ˆ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-secondary" id="btnSearchRequests">
                            <i class="fas fa-search"></i> æŸ¥è©¢è«‹æ±‚
                        </button>
                        <button class="btn-danger" id="btnDeleteSelected">
                            <i class="fas fa-trash"></i> åˆªé™¤é¸ä¸­è«‹æ±‚
                        </button>
                        <button class="btn-warning" id="btnClearSelection">
                            <i class="fas fa-times"></i> æ¸…é™¤é¸æ“‡
                        </button>
                    </div>
                    
                    <div id="requestsList" style="margin-top: 20px;">
                        <div class="no-requests">
                            <i class="fas fa-inbox fa-2x" style="margin-bottom: 10px;"></i>
                            <p>å°šæœªæŸ¥è©¢è«‹æ±‚ï¼Œè«‹é»æ“Šã€ŒæŸ¥è©¢è«‹æ±‚ã€æŒ‰éˆ•é–‹å§‹</p>
                        </div>
                    </div>
                    
                    <!-- åˆ†é æ§åˆ¶ -->
                    <div id="paginationControls" class="pagination" style="display: none;">
                        <button id="btnFirstPage" class="pagination-button">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button id="btnPrevPage" class="pagination-button">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <span class="page-info" id="pageInfo">ç¬¬ 1 é  / å…± 1 é </span>
                        <button id="btnNextPage" class="pagination-button">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button id="btnLastPage" class="pagination-button">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="result-section">
                    <div class="result-header">
                        <h3>ä¼ºæœå™¨å›æ‡‰</h3>
                        <div class="json-view-toggle">
                            <button id="btnRawJson" class="active">åŸå§‹ JSON</button>
                            <button id="btnFormattedJson">æ ¼å¼åŒ–</button>
                        </div>
                    </div>
                    
                    <div id="resultContent" class="result-content">
                        è«‹åœ¨å·¦å´è¡¨å–®å¡«å¯«è³‡è¨Šä¸¦æäº¤è«‹æ±‚ï¼Œçµæœå°‡é¡¯ç¤ºåœ¨æ­¤è™•ã€‚
                    </div>
                </div>
                
                <div class="result-section">
                    <div class="result-header">
                        <h3>è³‡æºé—œè¯ç‹€æ…‹</h3>
                    </div>
                    <div id="resourceStatus" class="result-content" style="max-height: 150px;">
                        è³‡æºé—œè¯ç‹€æ…‹å°‡é¡¯ç¤ºåœ¨æ­¤è™•ã€‚
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>æ€¥è¨ºé†«ç™‚æœå‹™è«‹æ±‚ç³»çµ± &copy; 2023 | ä½¿ç”¨ FHIR R4 æ¨™æº– | ä¼ºæœå™¨: https://hapi.fhir.org/baseR4/</p>
            <p>æ³¨æ„ï¼šæ­¤ç‚ºæ¼”ç¤ºç³»çµ±ï¼Œå¯¦éš›ä½¿ç”¨æ™‚éœ€è€ƒæ…®è³‡æ–™å®‰å…¨æ€§èˆ‡æ¬Šé™æ§åˆ¶</p>
        </footer>
    </div>

    <script>
        // å®šç¾© FHIR ä¼ºæœå™¨åŸºç¤ URL
        const FHIR_SERVER = 'https://hapi.fhir.org/baseR4/';
        
        // å…¨åŸŸè®Šæ•¸
        let requestHistory = [];
        let currentPractitioner = {
            id: null,
            name: null,
            verified: false,
            roleId: null
        };
        let currentPatient = {
            id: null,
            name: null,
            verified: false
        };
        let currentOrganization = {
            id: null,
            name: null,
            verified: false
        };
        let selectedRequests = new Set();
        let patientOptions = [];
        let practitionerOptions = [];
        
        // åˆ†é ç›¸é—œè®Šæ•¸
        let currentPage = 1;
        let totalPages = 1;
        let itemsPerPage = 5;
        let currentRequests = []; // å„²å­˜ç•¶å‰æŸ¥è©¢åˆ°çš„è«‹æ±‚
        
        // DOM å…ƒç´ 
        const tabForm = document.getElementById('tabForm');
        const tabJson = document.getElementById('tabJson');
        const formMode = document.getElementById('formMode');
        const jsonMode = document.getElementById('jsonMode');
        const selectedCountBadge = document.getElementById('selectedCountBadge');
        
        // çµ„ç¹”ç›¸é—œå…ƒç´ 
        const currentOrgName = document.getElementById('currentOrgName');
        const currentOrgId = document.getElementById('currentOrgId');
        const btnAutoCreateOrg = document.getElementById('btnAutoCreateOrg');
        const btnSearchOrgs = document.getElementById('btnSearchOrgs');
        const orgSelectGroup = document.getElementById('orgSelectGroup');
        const orgSelect = document.getElementById('orgSelect');
        const btnLoadOrg = document.getElementById('btnLoadOrg');
        
        // ç—…æ‚£ç›¸é—œå…ƒç´ 
        const patientSelect = document.getElementById('patientSelect');
        const searchPatientGroup = document.getElementById('searchPatientGroup');
        const patientSearchSelect = document.getElementById('patientSearchSelect');
        const btnSearchAllPatients = document.getElementById('btnSearchAllPatients');
        const newPatientForm = document.getElementById('newPatientForm');
        const newPatientLastName = document.getElementById('newPatientLastName');
        const newPatientFirstName = document.getElementById('newPatientFirstName');
        const newPatientGender = document.getElementById('newPatientGender');
        const newPatientBirthDate = document.getElementById('newPatientBirthDate');
        const newPatientId = document.getElementById('newPatientId');
        
        // é†«å¸«ç›¸é—œå…ƒç´ 
        const practitionerSelect = document.getElementById('practitionerSelect');
        const searchPractitionerGroup = document.getElementById('searchPractitionerGroup');
        const practitionerSearchSelect = document.getElementById('practitionerSearchSelect');
        const btnSearchAllPractitioners = document.getElementById('btnSearchAllPractitioners');
        const newPractitionerForm = document.getElementById('newPractitionerForm');
        const newPractitionerLastName = document.getElementById('newPractitionerLastName');
        const newPractitionerFirstName = document.getElementById('newPractitionerFirstName');
        const newPractitionerGender = document.getElementById('newPractitionerGender');
        const newPractitionerSpecialty = document.getElementById('newPractitionerSpecialty');
        const newPractitionerId = document.getElementById('newPractitionerId');
        
        // å…¶ä»–å…ƒç´ 
        const serviceType = document.getElementById('serviceType');
        const priority = document.getElementById('priority');
        const clinicalNote = document.getElementById('clinicalNote');
        const opCreate = document.getElementById('opCreate');
        const opUpdate = document.getElementById('opUpdate');
        const requestIdGroup = document.getElementById('requestIdGroup');
        const requestSelect = document.getElementById('requestSelect');
        const searchRequestGroup = document.getElementById('searchRequestGroup');
        const requestSearchResults = document.getElementById('requestSearchResults');
        const statusMessage = document.getElementById('statusMessage');
        const resultContent = document.getElementById('resultContent');
        const requestsList = document.getElementById('requestsList');
        const resourceStatus = document.getElementById('resourceStatus');
        
        // åˆ†é å…ƒç´ 
        const paginationControls = document.getElementById('paginationControls');
        const btnFirstPage = document.getElementById('btnFirstPage');
        const btnPrevPage = document.getElementById('btnPrevPage');
        const pageInfo = document.getElementById('pageInfo');
        const btnNextPage = document.getElementById('btnNextPage');
        const btnLastPage = document.getElementById('btnLastPage');
        
        // è³‡è¨Šé¡¯ç¤ºå…ƒç´ 
        const currentPatientId = document.getElementById('currentPatientId');
        const currentPatientName = document.getElementById('currentPatientName');
        const patientStatus = document.getElementById('patientStatus');
        const currentPractitionerId = document.getElementById('currentPractitionerId');
        const currentPractitionerName = document.getElementById('currentPractitionerName');
        const practitionerStatus = document.getElementById('practitionerStatus');
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¨­å®šäº‹ä»¶ç›£è½å™¨
            setupEventListeners();
            
            // åˆå§‹åŒ–ç³»çµ±
            initializeSystem();
            
            // é¡¯ç¤ºåˆå§‹ç‹€æ…‹
            setStatus('ç³»çµ±åˆå§‹åŒ–ä¸­...', 'info');
        });
        
        // åˆå§‹åŒ–ç³»çµ±
        async function initializeSystem() {
            try {
                // 1. å˜—è©¦è¼‰å…¥é è¨­çµ„ç¹”æˆ–è®“ä½¿ç”¨è€…é¸æ“‡
                await loadDefaultOrCreateOrganization();
                
                setStatus('ç³»çµ±å·²å°±ç·’ã€‚è«‹é¸æ“‡ç—…æ‚£ä¸¦å¡«å¯«æœå‹™è«‹æ±‚ã€‚', 'success');
                updateResourceStatus();
            } catch (error) {
                setStatus(`ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // è¼‰å…¥é è¨­çµ„ç¹”æˆ–å»ºç«‹æ–°çµ„ç¹”
        async function loadDefaultOrCreateOrganization() {
            try {
                setStatus('æª¢æŸ¥é è¨­çµ„ç¹”...', 'info');
                
                // å˜—è©¦è¼‰å…¥ç¯„ä¾‹çµ„ç¹”
                const response = await fetch(`${FHIR_SERVER}Organization/example`);
                
                if (response.ok) {
                    const org = await response.json();
                    currentOrganization.id = org.id;
                    currentOrganization.name = org.name || 'ç¯„ä¾‹çµ„ç¹”';
                    currentOrganization.verified = true;
                    updateOrganizationInfo();
                    setStatus(`å·²è¼‰å…¥ç¯„ä¾‹çµ„ç¹”: ${currentOrganization.name}`, 'success');
                    return true;
                } else {
                    // å»ºç«‹æ–°çµ„ç¹”
                    return await autoCreateOrganization();
                }
            } catch (error) {
                console.error('æª¢æŸ¥çµ„ç¹”æ™‚å‡ºéŒ¯:', error);
                return await autoCreateOrganization();
            }
        }
        
        // è‡ªå‹•å»ºç«‹çµ„ç¹”
        async function autoCreateOrganization() {
            const orgId = 'org-' + Date.now().toString().slice(-8);
            const orgName = `æ€¥è¨ºé†«å­¸ä¸­å¿ƒ_${new Date().toLocaleDateString()}`;
            
            try {
                setStatus(`æ­£åœ¨å»ºç«‹çµ„ç¹” ${orgName}...`, 'info');
                
                const orgData = {
                    resourceType: "Organization",
                    id: orgId,
                    active: true,
                    name: orgName,
                    type: [{
                        coding: [{
                            system: "http://terminology.hl7.org/CodeSystem/organization-type",
                            code: "prov",
                            display: "é†«ç™‚æä¾›è€…"
                        }]
                    }],
                    telecom: [{
                        system: "phone",
                        value: "+886-2-12345678",
                        use: "work"
                    }],
                    address: [{
                        use: "work",
                        line: ["å°ç£å°åŒ—å¸‚ä¸­æ­£å€ä¸­å±±å—è·¯1è™Ÿ"],
                        city: "å°åŒ—å¸‚",
                        country: "TW",
                        postalCode: "100"
                    }]
                };
                
                const response = await fetch(`${FHIR_SERVER}Organization/${orgId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/fhir+json' },
                    body: JSON.stringify(orgData)
                });
                
                if (response.ok) {
                    currentOrganization.id = orgId;
                    currentOrganization.name = orgName;
                    currentOrganization.verified = true;
                    updateOrganizationInfo();
                    setStatus(`çµ„ç¹”å»ºç«‹æˆåŠŸ: ${orgName}`, 'success');
                    return true;
                } else {
                    const result = await response.json();
                    setStatus(`å»ºç«‹çµ„ç¹”å¤±æ•—ï¼Œå°‡ä½¿ç”¨é è¨­çµ„ç¹”åç¨±`, 'warning');
                    currentOrganization.id = 'default-org';
                    currentOrganization.name = 'æ€¥è¨ºé†«å­¸ä¸­å¿ƒ';
                    currentOrganization.verified = false;
                    updateOrganizationInfo();
                    return false;
                }
            } catch (error) {
                console.error('å»ºç«‹çµ„ç¹”æ™‚å‡ºéŒ¯:', error);
                setStatus(`å»ºç«‹çµ„ç¹”æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œå°‡ä½¿ç”¨é è¨­çµ„ç¹”`, 'warning');
                currentOrganization.id = 'default-org';
                currentOrganization.name = 'æ€¥è¨ºé†«å­¸ä¸­å¿ƒ';
                currentOrganization.verified = false;
                updateOrganizationInfo();
                return false;
            }
        }
        
        // æ›´æ–°çµ„ç¹”è³‡è¨Šé¡¯ç¤º
        function updateOrganizationInfo() {
            currentOrgName.textContent = currentOrganization.name || 'æœªé¸æ“‡çµ„ç¹”';
            currentOrgId.textContent = `çµ„ç¹”ID: ${currentOrganization.id || 'æœªè¨­å®š'}`;
            
            if (currentOrganization.verified) {
                currentOrgName.style.color = '#c6f6d5';
                currentOrgId.style.color = '#c6f6d5';
            } else {
                currentOrgName.style.color = '#feebc8';
                currentOrgId.style.color = '#feebc8';
            }
            
            // ç•¶çµ„ç¹”è®Šæ›´æ™‚ï¼Œé‡æ–°è¼‰å…¥ç›¸é—œè³‡æ–™
            if (currentOrganization.id && currentOrganization.verified) {
                // é‡æ–°è¼‰å…¥é†«å¸«å’Œç—…æ‚£é¸é …
                if (searchPractitionerGroup.style.display !== 'none') {
                    loadPractitionerOptions();
                }
                if (searchPatientGroup.style.display !== 'none') {
                    loadPatientOptions();
                }
            }
        }
        
        // æ›´æ–°å·²é¸è«‹æ±‚è¨ˆæ•¸
        function updateSelectedCount() {
            const count = selectedRequests.size;
            if (count > 0) {
                selectedCountBadge.textContent = `å·²é¸ ${count}`;
                selectedCountBadge.style.display = 'inline-block';
            } else {
                selectedCountBadge.style.display = 'none';
            }
        }
        
        // æ›´æ–°è³‡æºé—œè¯ç‹€æ…‹
        function updateResourceStatus() {
            let status = '';
            
            status += `çµ„ç¹”: ${currentOrganization.verified ? 'âœ“' : 'âœ—'} ${currentOrganization.name || 'æœªé¸æ“‡'}\n`;
            status += `é†«å¸«: ${currentPractitioner.verified ? 'âœ“' : 'âœ—'} ${currentPractitioner.name || 'æœªé¸æ“‡'}\n`;
            status += `ç—…æ‚£: ${currentPatient.verified ? 'âœ“' : 'âœ—'} ${currentPatient.name || 'æœªé¸æ“‡'}\n`;
            
            if (currentPractitioner.roleId) {
                status += `é†«å¸«è§’è‰²: âœ“ PractitionerRole/${currentPractitioner.roleId}\n`;
            } else if (currentPractitioner.id) {
                status += `é†«å¸«è§’è‰²: âœ— æœªå»ºç«‹ PractitionerRole\n`;
            }
            
            resourceStatus.textContent = status;
        }
        
        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // æ¨¡å¼åˆ‡æ›
            tabForm.addEventListener('click', () => switchMode('form'));
            tabJson.addEventListener('click', () => switchMode('json'));
            
            // çµ„ç¹”æ§åˆ¶äº‹ä»¶
            btnAutoCreateOrg.addEventListener('click', autoCreateOrganization);
            btnSearchOrgs.addEventListener('click', toggleOrgSearch);
            btnLoadOrg.addEventListener('click', loadSelectedOrganization);
            
            // ç—…æ‚£é¸æ“‡äº‹ä»¶
            patientSelect.addEventListener('change', handlePatientSelect);
            btnSearchAllPatients.addEventListener('click', loadPatientOptions);
            patientSearchSelect.addEventListener('change', handlePatientSearchSelect);
            document.getElementById('btnCreatePatient').addEventListener('click', createNewPatient);
            
            // é†«å¸«é¸æ“‡äº‹ä»¶
            practitionerSelect.addEventListener('change', handlePractitionerSelect);
            practitionerSearchSelect.addEventListener('change', handlePractitionerSearchSelect);
            btnSearchAllPractitioners.addEventListener('click', loadPractitionerOptions);
            document.getElementById('btnCreatePractitioner').addEventListener('click', createNewPractitioner);
            
            // è¡¨å–®æ¨¡å¼æŒ‰éˆ•
            document.getElementById('btnSubmit').addEventListener('click', submitRequest);
            document.getElementById('btnLoadEmergency').addEventListener('click', loadEmergencyExample);
            document.getElementById('btnLoadMyRequests').addEventListener('click', loadMyRequests);
            
            // JSON æ¨¡å¼æŒ‰éˆ•
            document.getElementById('btnJsonCreate').addEventListener('click', jsonCreate);
            document.getElementById('btnJsonRead').addEventListener('click', jsonRead);
            document.getElementById('btnJsonUpdate').addEventListener('click', jsonUpdate);
            document.getElementById('btnJsonDelete').addEventListener('click', jsonDelete);
            
            // è«‹æ±‚ç®¡ç†æŒ‰éˆ•
            document.getElementById('btnSearchRequests').addEventListener('click', searchRequests);
            document.getElementById('btnDeleteSelected').addEventListener('click', deleteSelectedRequests);
            document.getElementById('btnClearSelection').addEventListener('click', clearSelection);
            
            // åˆ†é æŒ‰éˆ•
            btnFirstPage.addEventListener('click', () => goToPage(1));
            btnPrevPage.addEventListener('click', () => goToPage(currentPage - 1));
            btnNextPage.addEventListener('click', () => goToPage(currentPage + 1));
            btnLastPage.addEventListener('click', () => goToPage(totalPages));
            
            // æ“ä½œé¡å‹åˆ‡æ›
            opCreate.addEventListener('change', toggleOperationMode);
            opUpdate.addEventListener('change', toggleOperationMode);
            
            // è«‹æ±‚é¸æ“‡
            requestSelect.addEventListener('change', handleRequestSelect);
            
            // JSON é¡¯ç¤ºåˆ‡æ›
            document.getElementById('btnRawJson').addEventListener('click', () => toggleJsonView('raw'));
            document.getElementById('btnFormattedJson').addEventListener('click', () => toggleJsonView('formatted'));
        }
        
        // æ¸…é™¤é¸æ“‡
        function clearSelection() {
            selectedRequests.clear();
            updateSelectedCount();
            // ç§»é™¤æ‰€æœ‰è«‹æ±‚é …ç›®çš„é¸ä¸­æ¨£å¼
            document.querySelectorAll('.request-item').forEach(item => {
                item.classList.remove('selected');
            });
            setStatus('å·²æ¸…é™¤æ‰€æœ‰é¸æ“‡', 'info');
        }
        
        // åˆ‡æ›çµ„ç¹”æœå°‹é¡¯ç¤º
        function toggleOrgSearch() {
            if (orgSelectGroup.style.display === 'none') {
                orgSelectGroup.style.display = 'flex';
                loadOrganizationOptions();
            } else {
                orgSelectGroup.style.display = 'none';
            }
        }
        
        // è¼‰å…¥çµ„ç¹”é¸é …
        async function loadOrganizationOptions() {
            try {
                setStatus('è¼‰å…¥çµ„ç¹”åˆ—è¡¨ä¸­...', 'info');
                
                const response = await fetch(`${FHIR_SERVER}Organization?_count=20&_sort=-_lastUpdated`);
                const result = await response.json();
                
                if (response.ok && result.entry && result.entry.length > 0) {
                    // æ¸…ç©ºç¾æœ‰é¸é …
                    orgSelect.innerHTML = '<option value="">-- é¸æ“‡ç¾æœ‰çµ„ç¹” --</option>';
                    
                    // æ·»åŠ çµ„ç¹”é¸é …
                    result.entry.forEach((entry, index) => {
                        const org = entry.resource;
                        const orgId = org.id;
                        const orgName = org.name || 'æœªå‘½åçµ„ç¹”';
                        
                        const option = document.createElement('option');
                        option.value = orgId;
                        option.textContent = `${orgName} (ID: ${orgId})`;
                        orgSelect.appendChild(option);
                    });
                    
                    setStatus(`è¼‰å…¥ ${result.entry.length} å€‹çµ„ç¹”`, 'success');
                } else {
                    setStatus('æœªæ‰¾åˆ°çµ„ç¹”', 'warning');
                }
            } catch (error) {
                setStatus(`è¼‰å…¥çµ„ç¹”æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // è¼‰å…¥é¸å®šçš„çµ„ç¹”
        async function loadSelectedOrganization() {
            const orgId = orgSelect.value;
            if (!orgId) {
                setStatus('è«‹é¸æ“‡çµ„ç¹”', 'error');
                return;
            }
            
            try {
                setStatus(`æ­£åœ¨è¼‰å…¥çµ„ç¹” ${orgId}...`, 'info');
                
                const response = await fetch(`${FHIR_SERVER}Organization/${orgId}`);
                
                if (response.ok) {
                    const org = await response.json();
                    currentOrganization.id = org.id;
                    currentOrganization.name = org.name || 'æœªå‘½åçµ„ç¹”';
                    currentOrganization.verified = true;
                    
                    updateOrganizationInfo();
                    orgSelectGroup.style.display = 'none';
                    
                    setStatus(`å·²è¼‰å…¥çµ„ç¹”: ${currentOrganization.name}`, 'success');
                    updateResourceStatus();
                } else {
                    setStatus(`è¼‰å…¥çµ„ç¹”å¤±æ•—`, 'error');
                }
            } catch (error) {
                setStatus(`è¼‰å…¥çµ„ç¹”æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // åˆ‡æ›æ¨¡å¼
        function switchMode(mode) {
            if (mode === 'form') {
                tabForm.classList.add('active');
                tabJson.classList.remove('active');
                formMode.classList.remove('hidden');
                jsonMode.classList.add('hidden');
                setStatus('å·²åˆ‡æ›è‡³è¡¨å–®æ¨¡å¼', 'info');
            } else {
                tabForm.classList.remove('active');
                tabJson.classList.add('active');
                formMode.classList.add('hidden');
                jsonMode.classList.remove('hidden');
                setStatus('å·²åˆ‡æ›è‡³ JSON æ¨¡å¼', 'info');
            }
        }
        
        // è™•ç†ç—…æ‚£é¸æ“‡
        function handlePatientSelect() {
            const value = patientSelect.value;
            
            // éš±è—æ‰€æœ‰ç›¸é—œå€åŸŸ
            searchPatientGroup.style.display = 'none';
            newPatientForm.style.display = 'none';
            
            if (value === 'search-patient') {
                searchPatientGroup.style.display = 'block';
                setStatus('è«‹å¾ä¸‹æ‹‰é¸å–®é¸æ“‡ç—…æ‚£', 'info');
                loadPatientOptions();
            } else if (value === 'new-patient') {
                newPatientForm.style.display = 'block';
                setStatus('è«‹å¡«å¯«æ–°ç—…æ‚£è³‡è¨Š', 'info');
            } else if (value) {
                // é¸æ“‡ç¾æœ‰ç—…æ‚£
                checkPatient(value);
            }
        }
        
        // è¼‰å…¥ç—…æ‚£é¸é …ï¼ˆåªé¡¯ç¤ºç•¶å‰çµ„ç¹”ä¸‹çš„ç—…æ‚£ï¼‰
        async function loadPatientOptions() {
            if (!currentOrganization.id || !currentOrganization.verified) {
                setStatus('è«‹å…ˆé¸æ“‡çµ„ç¹”', 'error');
                return;
            }
            
            try {
                setStatus('è¼‰å…¥ç—…æ‚£åˆ—è¡¨ä¸­...', 'info');
                
                // æ–¹æ³•1ï¼šé€éServiceRequestæŸ¥æ‰¾èˆ‡ç•¶å‰çµ„ç¹”ç›¸é—œçš„ç—…æ‚£
                // å…ˆæŸ¥æ‰¾ç•¶å‰çµ„ç¹”çš„ServiceRequestï¼Œç„¶å¾Œå–å¾—ç›¸é—œçš„ç—…æ‚£ID
                const serviceRequestResponse = await fetch(`${FHIR_SERVER}ServiceRequest?performer=Organization/${currentOrganization.id}&_count=50&_include=ServiceRequest:subject`);
                
                if (serviceRequestResponse.ok) {
                    const result = await serviceRequestResponse.json();
                    const patientMap = new Map();
                    
                    if (result.entry && result.entry.length > 0) {
                        // å¾ServiceRequestä¸­æå–ç—…æ‚£è³‡è¨Š
                        result.entry.forEach(entry => {
                            if (entry.resource.resourceType === 'Patient') {
                                const patient = entry.resource;
                                patientMap.set(patient.id, patient);
                            }
                        });
                    }
                    
                    // æ¸…ç©ºç¾æœ‰é¸é …
                    patientSearchSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡ç—…æ‚£ --</option>';
                    
                    // å„²å­˜ç—…æ‚£é¸é …
                    patientOptions = Array.from(patientMap.values()).map(patient => {
                        return {
                            id: patient.id,
                            name: getPatientName(patient),
                            resource: patient
                        };
                    });
                    
                    // æ·»åŠ ç—…æ‚£é¸é …åˆ°ä¸‹æ‹‰é¸å–®
                    patientOptions.forEach((patient, index) => {
                        const option = document.createElement('option');
                        option.value = patient.id;
                        option.textContent = `${patient.name} (ID: ${patient.id})`;
                        patientSearchSelect.appendChild(option);
                    });
                    
                    setStatus(`è¼‰å…¥ ${patientOptions.length} å€‹ç—…æ‚£`, 'success');
                } else {
                    setStatus('æœªæ‰¾åˆ°ç—…æ‚£', 'warning');
                }
            } catch (error) {
                setStatus(`è¼‰å…¥ç—…æ‚£æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // è™•ç†ç—…æ‚£æœå°‹é¸æ“‡
        function handlePatientSearchSelect() {
            const patientId = patientSearchSelect.value;
            if (patientId) {
                checkPatient(patientId);
            }
        }
        
        // æª¢æŸ¥ç—…æ‚£è³‡æºæ˜¯å¦å­˜åœ¨
        async function checkPatient(patientId) {
            try {
                setStatus(`æ­£åœ¨æª¢æŸ¥ç—…æ‚£ ${patientId}...`, 'info');
                
                const response = await fetch(`${FHIR_SERVER}Patient/${patientId}`);
                
                if (response.ok) {
                    const patient = await response.json();
                    
                    // æ›´æ–°ç—…æ‚£è³‡è¨Š
                    currentPatient.id = patientId;
                    currentPatient.name = getPatientName(patient);
                    currentPatient.verified = true;
                    
                    // æ›´æ–°é¡¯ç¤º
                    updatePatientInfo();
                    
                    setStatus(`ç—…æ‚£ ${currentPatient.name} (ID: ${patientId}) å·²æ‰¾åˆ°`, 'success');
                    updateResourceStatus();
                    return true;
                } else {
                    // ç—…æ‚£ä¸å­˜åœ¨
                    currentPatient.id = patientId;
                    currentPatient.name = 'æœªçŸ¥';
                    currentPatient.verified = false;
                    
                    updatePatientInfo();
                    
                    setStatus(`ç—…æ‚£ ${patientId} ä¸å­˜åœ¨`, 'warning');
                    updateResourceStatus();
                    return false;
                }
            } catch (error) {
                setStatus(`æª¢æŸ¥ç—…æ‚£æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                return false;
            }
        }
        
        // å»ºç«‹æ–°ç—…æ‚£è³‡æº
        async function createNewPatient() {
            const lastName = newPatientLastName.value.trim();
            const firstName = newPatientFirstName.value.trim();
            const gender = newPatientGender.value;
            const birthDate = newPatientBirthDate.value;
            let patientId = newPatientId.value.trim();
            
            if (!lastName || !firstName) {
                setStatus('è«‹å¡«å¯«ç—…æ‚£å§“å', 'error');
                return;
            }
            
            // å¦‚æœæœªæŒ‡å®š IDï¼Œè‡ªå‹•ç”¢ç”Ÿ
            if (!patientId) {
                patientId = 'patient-' + Date.now().toString().slice(-8);
            }
            
            try {
                setStatus(`æ­£åœ¨å»ºç«‹ç—…æ‚£è³‡æº ${patientId}...`, 'info');
                
                const patientData = {
                    resourceType: "Patient",
                    id: patientId,
                    active: true,
                    name: [{
                        use: "official",
                        text: `${lastName}${firstName}`,
                        family: lastName,
                        given: [firstName]
                    }],
                    gender: gender,
                    birthDate: birthDate || undefined,
                    // æ·»åŠ çµ„ç¹”æ¨™è¨˜
                    meta: {
                        tag: [{
                            system: "http://example.com/organization",
                            code: currentOrganization.id
                        }]
                    }
                };
                
                const response = await fetch(`${FHIR_SERVER}Patient/${patientId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/fhir+json' },
                    body: JSON.stringify(patientData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // æ›´æ–°ç—…æ‚£è³‡è¨Š
                    currentPatient.id = patientId;
                    currentPatient.name = `${lastName}${firstName}`;
                    currentPatient.verified = true;
                    
                    // æ›´æ–°é¸æ“‡
                    patientSelect.value = patientId;
                    newPatientForm.style.display = 'none';
                    
                    updatePatientInfo();
                    
                    setStatus(`ç—…æ‚£è³‡æº ${patientId} å»ºç«‹æˆåŠŸï¼`, 'success');
                    displayResult(result, `å»ºç«‹ç—…æ‚£å›æ‡‰`);
                    updateResourceStatus();
                    
                    // é‡æ–°è¼‰å…¥ç—…æ‚£åˆ—è¡¨
                    if (searchPatientGroup.style.display !== 'none') {
                        loadPatientOptions();
                    }
                    
                    return true;
                } else {
                    setStatus(`å»ºç«‹ç—…æ‚£å¤±æ•—: ${result.issue?.[0]?.details?.text || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                    displayResult(result, 'éŒ¯èª¤å›æ‡‰');
                    return false;
                }
            } catch (error) {
                setStatus(`éŒ¯èª¤: ${error.message}`, 'error');
                displayResult(`å»ºç«‹ç—…æ‚£æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'éŒ¯èª¤');
                return false;
            }
        }
        
        // è™•ç†é†«å¸«é¸æ“‡
        function handlePractitionerSelect() {
            const value = practitionerSelect.value;
            
            // éš±è—æ‰€æœ‰ç›¸é—œå€åŸŸ
            searchPractitionerGroup.style.display = 'none';
            newPractitionerForm.style.display = 'none';
            
            if (value === 'search-practitioner') {
                searchPractitionerGroup.style.display = 'block';
                setStatus('è«‹å¾ä¸‹æ‹‰é¸å–®é¸æ“‡é†«å¸«', 'info');
                loadPractitionerOptions();
            } else if (value === 'new-practitioner') {
                newPractitionerForm.style.display = 'block';
                setStatus('è«‹å¡«å¯«æ–°é†«å¸«è³‡è¨Š', 'info');
            } else if (value) {
                // é¸æ“‡ç¾æœ‰é†«å¸«
                checkPractitioner(value);
            }
        }
        
        // è¼‰å…¥é†«å¸«é¸é …ï¼ˆåªé¡¯ç¤ºç•¶å‰çµ„ç¹”ä¸‹çš„é†«å¸«ï¼‰
        async function loadPractitionerOptions() {
            if (!currentOrganization.id || !currentOrganization.verified) {
                setStatus('è«‹å…ˆé¸æ“‡çµ„ç¹”', 'error');
                return;
            }
            
            try {
                setStatus('è¼‰å…¥é†«å¸«åˆ—è¡¨ä¸­...', 'info');
                
                // æŸ¥è©¢å±¬æ–¼ç•¶å‰çµ„ç¹”çš„PractitionerRoleï¼Œä¸¦åŒ…å«Practitionerè³‡æº
                const response = await fetch(`${FHIR_SERVER}PractitionerRole?organization=Organization/${currentOrganization.id}&_include=PractitionerRole:practitioner&_count=20`);
                const result = await response.json();
                
                if (response.ok && result.entry && result.entry.length > 0) {
                    // æ¸…ç©ºç¾æœ‰é¸é …
                    practitionerSearchSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡é†«å¸« --</option>';
                    
                    // å„²å­˜é†«å¸«é¸é …
                    practitionerOptions = [];
                    const practitionerMap = new Map();
                    
                    result.entry.forEach(entry => {
                        const resource = entry.resource;
                        if (resource.resourceType === 'Practitioner') {
                            practitionerMap.set(resource.id, resource);
                        } else if (resource.resourceType === 'PractitionerRole' && resource.practitioner) {
                            // å¾PractitionerRoleä¸­ç²å–é†«å¸«ID
                            const practitionerId = resource.practitioner.reference.split('/')[1];
                            // å¦‚æœæœ‰å°æ‡‰çš„Practitionerè³‡æºï¼Œå·²ç¶“åœ¨mapä¸­
                        }
                    });
                    
                    // å°‡mapè½‰æ›ç‚ºæ•¸çµ„
                    practitionerOptions = Array.from(practitionerMap.values()).map(practitioner => {
                        return {
                            id: practitioner.id,
                            name: getPractitionerName(practitioner),
                            resource: practitioner
                        };
                    });
                    
                    // æ·»åŠ é†«å¸«é¸é …åˆ°ä¸‹æ‹‰é¸å–®
                    practitionerOptions.forEach((practitioner, index) => {
                        const option = document.createElement('option');
                        option.value = practitioner.id;
                        option.textContent = `${practitioner.name} (ID: ${practitioner.id})`;
                        practitionerSearchSelect.appendChild(option);
                    });
                    
                    setStatus(`è¼‰å…¥ ${practitionerOptions.length} å€‹é†«å¸«`, 'success');
                } else {
                    setStatus('æœªæ‰¾åˆ°é†«å¸«', 'warning');
                }
            } catch (error) {
                setStatus(`è¼‰å…¥é†«å¸«æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // è™•ç†é†«å¸«æœå°‹é¸æ“‡
        function handlePractitionerSearchSelect() {
            const practitionerId = practitionerSearchSelect.value;
            if (practitionerId) {
                checkPractitioner(practitionerId);
            }
        }
        
        // æª¢æŸ¥é†«å¸«è³‡æºæ˜¯å¦å­˜åœ¨
        async function checkPractitioner(practitionerId) {
            try {
                setStatus(`æ­£åœ¨æª¢æŸ¥é†«å¸« ${practitionerId}...`, 'info');
                
                const response = await fetch(`${FHIR_SERVER}Practitioner/${practitionerId}`);
                
                if (response.ok) {
                    const practitioner = await response.json();
                    
                    // æ›´æ–°é†«å¸«è³‡è¨Š
                    currentPractitioner.id = practitionerId;
                    currentPractitioner.name = getPractitionerName(practitioner);
                    currentPractitioner.verified = true;
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰å°æ‡‰çš„ PractitionerRole
                    await checkPractitionerRole(practitionerId);
                    
                    // æ›´æ–°é¡¯ç¤º
                    updatePractitionerInfo();
                    
                    setStatus(`é†«å¸« ${currentPractitioner.name} (ID: ${practitionerId}) å·²æ‰¾åˆ°`, 'success');
                    updateResourceStatus();
                    return true;
                } else {
                    // é†«å¸«ä¸å­˜åœ¨
                    currentPractitioner.id = practitionerId;
                    currentPractitioner.name = 'æœªçŸ¥';
                    currentPractitioner.verified = false;
                    currentPractitioner.roleId = null;
                    
                    updatePractitionerInfo();
                    
                    setStatus(`é†«å¸« ${practitionerId} ä¸å­˜åœ¨`, 'warning');
                    updateResourceStatus();
                    return false;
                }
            } catch (error) {
                setStatus(`æª¢æŸ¥é†«å¸«æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                return false;
            }
        }
        
        // æª¢æŸ¥ PractitionerRole
        async function checkPractitionerRole(practitionerId) {
            try {
                const response = await fetch(`${FHIR_SERVER}PractitionerRole?practitioner=Practitioner/${practitionerId}&organization=Organization/${currentOrganization.id}&_count=10`);
                const result = await response.json();
                
                if (response.ok && result.entry && result.entry.length > 0) {
                    // ä½¿ç”¨ç¬¬ä¸€å€‹æ‰¾åˆ°çš„ PractitionerRole
                    currentPractitioner.roleId = result.entry[0].resource.id;
                    return true;
                } else {
                    currentPractitioner.roleId = null;
                    return false;
                }
            } catch (error) {
                console.error('æª¢æŸ¥ PractitionerRole æ™‚å‡ºéŒ¯:', error);
                currentPractitioner.roleId = null;
                return false;
            }
        }
        
        // å»ºç«‹æ–°é†«å¸«è³‡æºï¼ˆåŒ…å« PractitionerRoleï¼‰
        async function createNewPractitioner() {
            const lastName = newPractitionerLastName.value.trim();
            const firstName = newPractitionerFirstName.value.trim();
            const gender = newPractitionerGender.value;
            const specialty = newPractitionerSpecialty.value;
            let practitionerId = newPractitionerId.value.trim();
            
            if (!lastName || !firstName) {
                setStatus('è«‹å¡«å¯«é†«å¸«å§“å', 'error');
                return;
            }
            
            // å¦‚æœæœªæŒ‡å®š IDï¼Œè‡ªå‹•ç”¢ç”Ÿ
            if (!practitionerId) {
                practitionerId = 'practitioner-' + Date.now().toString().slice(-8);
            }
            
            try {
                setStatus(`æ­£åœ¨å»ºç«‹é†«å¸«è³‡æº ${practitionerId}...`, 'info');
                
                // 1. å»ºç«‹ Practitioner è³‡æº
                const practitionerData = {
                    resourceType: "Practitioner",
                    id: practitionerId,
                    active: true,
                    name: [{
                        use: "official",
                        text: `${lastName}${firstName}`,
                        family: lastName,
                        given: [firstName]
                    }],
                    gender: gender,
                    telecom: [{
                        system: "phone",
                        value: "+886-2-12345678",
                        use: "work"
                    }],
                    address: [{
                        use: "work",
                        line: ["å°ç£å°åŒ—å¸‚ä¸­æ­£å€ä¸­å±±å—è·¯1è™Ÿ"],
                        city: "å°åŒ—å¸‚",
                        country: "TW"
                    }]
                };
                
                const practitionerResponse = await fetch(`${FHIR_SERVER}Practitioner/${practitionerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/fhir+json' },
                    body: JSON.stringify(practitionerData)
                });
                
                if (!practitionerResponse.ok) {
                    const result = await practitionerResponse.json();
                    setStatus(`å»ºç«‹ Practitioner å¤±æ•—: ${result.issue?.[0]?.details?.text || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                    return false;
                }
                
                // 2. å»ºç«‹ PractitionerRole è³‡æº
                const roleId = `role-${practitionerId}`;
                const specialtyCodes = {
                    'emergency': '408467006',
                    'internal': '419772000',
                    'surgery': '408476004',
                    'pediatrics': '408443003',
                    'radiology': '408468001'
                };
                
                const roleData = {
                    resourceType: "PractitionerRole",
                    id: roleId,
                    active: true,
                    practitioner: {
                        reference: `Practitioner/${practitionerId}`,
                        display: `${lastName}${firstName}`
                    },
                    organization: {
                        reference: `Organization/${currentOrganization.id}`,
                        display: currentOrganization.name
                    },
                    code: [{
                        coding: [{
                            system: "http://snomed.info/sct",
                            code: "309343006",
                            display: "æ€¥è¨ºé†«å­¸é†«å¸«"
                        }]
                    }],
                    specialty: [{
                        coding: [{
                            system: "http://snomed.info/sct",
                            code: specialtyCodes[specialty] || '309343006',
                            display: getSpecialtyDisplay(specialty)
                        }]
                    }],
                    telecom: [{
                        system: "phone",
                        value: "+886-2-12345678",
                        use: "work"
                    }]
                };
                
                const roleResponse = await fetch(`${FHIR_SERVER}PractitionerRole/${roleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/fhir+json' },
                    body: JSON.stringify(roleData)
                });
                
                if (roleResponse.ok) {
                    // æ›´æ–°é†«å¸«è³‡è¨Š
                    currentPractitioner.id = practitionerId;
                    currentPractitioner.name = `${lastName}${firstName}`;
                    currentPractitioner.verified = true;
                    currentPractitioner.roleId = roleId;
                    
                    // æ›´æ–°é¸æ“‡
                    practitionerSelect.value = practitionerId;
                    newPractitionerForm.style.display = 'none';
                    
                    updatePractitionerInfo();
                    
                    setStatus(`é†«å¸«è³‡æºå»ºç«‹æˆåŠŸï¼Practitioner: ${practitionerId}, PractitionerRole: ${roleId}`, 'success');
                    updateResourceStatus();
                    
                    // é‡æ–°è¼‰å…¥é†«å¸«åˆ—è¡¨
                    if (searchPractitionerGroup.style.display !== 'none') {
                        loadPractitionerOptions();
                    }
                    
                    return true;
                } else {
                    // å³ä½¿ PractitionerRole å»ºç«‹å¤±æ•—ï¼ŒPractitioner é‚„æ˜¯å»ºç«‹äº†
                    const result = await roleResponse.json();
                    setStatus(`å»ºç«‹ PractitionerRole å¤±æ•—ï¼Œä½† Practitioner å·²å»ºç«‹`, 'warning');
                    
                    // æ›´æ–°é†«å¸«è³‡è¨Šï¼ˆæ²’æœ‰ roleï¼‰
                    currentPractitioner.id = practitionerId;
                    currentPractitioner.name = `${lastName}${firstName}`;
                    currentPractitioner.verified = true;
                    currentPractitioner.roleId = null;
                    
                    practitionerSelect.value = practitionerId;
                    newPractitionerForm.style.display = 'none';
                    
                    updatePractitionerInfo();
                    updateResourceStatus();
                    
                    return false;
                }
            } catch (error) {
                setStatus(`éŒ¯èª¤: ${error.message}`, 'error');
                displayResult(`å»ºç«‹é†«å¸«æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'éŒ¯èª¤');
                return false;
            }
        }
        
        // å–å¾—å°ˆç§‘é¡¯ç¤ºæ–‡å­—
        function getSpecialtyDisplay(specialty) {
            const specialtyMap = {
                'emergency': 'æ€¥è¨ºé†«å­¸',
                'internal': 'å…§ç§‘',
                'surgery': 'å¤–ç§‘',
                'pediatrics': 'å°å…’ç§‘',
                'radiology': 'æ”¾å°„ç§‘'
            };
            return specialtyMap[specialty] || 'æ€¥è¨ºé†«å­¸';
        }
        
        // æ›´æ–°ç—…æ‚£è³‡è¨Šé¡¯ç¤º
        function updatePatientInfo() {
            currentPatientId.textContent = currentPatient.id || 'æœªé¸æ“‡';
            currentPatientName.textContent = currentPatient.name || 'æœªé¸æ“‡';
            
            if (currentPatient.verified) {
                patientStatus.textContent = 'å·²é©—è­‰';
                patientStatus.style.color = '#38a169';
            } else {
                patientStatus.textContent = 'æœªé©—è­‰';
                patientStatus.style.color = '#e53e3e';
            }
        }
        
        // æ›´æ–°é†«å¸«è³‡è¨Šé¡¯ç¤º
        function updatePractitionerInfo() {
            currentPractitionerId.textContent = currentPractitioner.id || 'æœªé¸æ“‡';
            currentPractitionerName.textContent = currentPractitioner.name || 'æœªé¸æ“‡';
            
            if (currentPractitioner.verified) {
                practitionerStatus.textContent = currentPractitioner.roleId ? 'å·²é©—è­‰ (æœ‰è§’è‰²)' : 'å·²é©—è­‰ (ç„¡è§’è‰²)';
                practitionerStatus.style.color = currentPractitioner.roleId ? '#38a169' : '#ed8936';
            } else {
                practitionerStatus.textContent = 'æœªé©—è­‰';
                practitionerStatus.style.color = '#e53e3e';
            }
        }
        
        // è¨­å®šç‹€æ…‹è¨Šæ¯
        function setStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message';
            
            if (type === 'success') {
                statusMessage.classList.add('status-success');
            } else if (type === 'error') {
                statusMessage.classList.add('status-error');
            } else if (type === 'warning') {
                statusMessage.classList.add('status-warning');
            } else {
                statusMessage.classList.add('status-info');
            }
            
            // 5ç§’å¾Œè‡ªå‹•æ¸…é™¤æˆåŠŸ/è³‡è¨Š/è­¦å‘Šè¨Šæ¯
            if (type !== 'error') {
                setTimeout(() => {
                    statusMessage.className = 'status-message';
                    statusMessage.textContent = '';
                }, 5000);
            }
        }
        
        // è¼‰å…¥æ€¥è¨ºç¯„ä¾‹
        async function loadEmergencyExample() {
            if (!currentOrganization.id || !currentOrganization.verified) {
                setStatus('è«‹å…ˆé¸æ“‡çµ„ç¹”', 'error');
                return;
            }
            
            try {
                setStatus('æ­£åœ¨è¼‰å…¥æ€¥è¨ºç¯„ä¾‹...', 'info');
                
                // å‰µå»ºæ€¥è¨ºç¯„ä¾‹ç—…æ‚£
                const patientId = 'emergency-patient-' + Date.now().toString().slice(-8);
                const patientData = {
                    resourceType: "Patient",
                    id: patientId,
                    active: true,
                    name: [{
                        use: "official",
                        text: "æ€¥è¨ºç¯„ä¾‹ç—…æ‚£",
                        family: "å¼µ",
                        given: ["å¤§ç‚º"]
                    }],
                    gender: "male",
                    birthDate: "1985-05-15",
                    meta: {
                        tag: [{
                            system: "http://example.com/organization",
                            code: currentOrganization.id
                        }]
                    }
                };
                
                const patientResponse = await fetch(`${FHIR_SERVER}Patient/${patientId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/fhir+json' },
                    body: JSON.stringify(patientData)
                });
                
                if (patientResponse.ok) {
                    // æ›´æ–°ç—…æ‚£è³‡è¨Š
                    currentPatient.id = patientId;
                    currentPatient.name = "å¼µå¤§ç‚º";
                    currentPatient.verified = true;
                    updatePatientInfo();
                    patientSelect.value = patientId;
                }
                
                // å‰µå»ºæ€¥è¨ºç¯„ä¾‹é†«å¸«
                const practitionerId = 'emergency-practitioner-' + Date.now().toString().slice(-8);
                const practitionerData = {
                    resourceType: "Practitioner",
                    id: practitionerId,
                    active: true,
                    name: [{
                        use: "official",
                        text: "æ€¥è¨ºç¯„ä¾‹é†«å¸«",
                        family: "é™³",
                        given: ["é†«å¸«"]
                    }],
                    gender: "male",
                    telecom: [{
                        system: "phone",
                        value: "+886-2-12345678",
                        use: "work"
                    }]
                };
                
                const practitionerResponse = await fetch(`${FHIR_SERVER}Practitioner/${practitionerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/fhir+json' },
                    body: JSON.stringify(practitionerData)
                });
                
                if (practitionerResponse.ok) {
                    // æ›´æ–°é†«å¸«è³‡è¨Š
                    currentPractitioner.id = practitionerId;
                    currentPractitioner.name = "é™³é†«å¸«";
                    currentPractitioner.verified = true;
                    updatePractitionerInfo();
                    practitionerSelect.value = practitionerId;
                    
                    // å‰µå»º PractitionerRole
                    const roleId = `role-${practitionerId}`;
                    const roleData = {
                        resourceType: "PractitionerRole",
                        id: roleId,
                        active: true,
                        practitioner: {
                            reference: `Practitioner/${practitionerId}`,
                            display: "é™³é†«å¸«"
                        },
                        organization: {
                            reference: `Organization/${currentOrganization.id}`,
                            display: currentOrganization.name
                        },
                        code: [{
                            coding: [{
                                system: "http://snomed.info/sct",
                                code: "309343006",
                                display: "æ€¥è¨ºé†«å­¸é†«å¸«"
                            }]
                        }],
                        specialty: [{
                            coding: [{
                                system: "http://snomed.info/sct",
                                code: "408467006",
                                display: "æ€¥è¨ºé†«å­¸"
                            }]
                        }]
                    };
                    
                    await fetch(`${FHIR_SERVER}PractitionerRole/${roleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/fhir+json' },
                        body: JSON.stringify(roleData)
                    });
                    
                    currentPractitioner.roleId = roleId;
                }
                
                // è¨­å®šè¡¨å–®å€¼
                serviceType.value = 'lab-blood';
                priority.value = 'stat';
                clinicalNote.value = 'è»Šç¦å¤–å‚·æ‚£è€…ï¼Œéœ€ç·Šæ€¥è¡€æ¶²æª¢é©—è©•ä¼°ç”Ÿå‘½å¾µè±¡ã€‚ç–‘ä¼¼å…§å‡ºè¡€ï¼Œéœ€ç·Šæ€¥è¼¸è¡€æº–å‚™ã€‚';
                opCreate.checked = true;
                toggleOperationMode();
                
                // éš±è—æœå°‹å€åŸŸ
                searchPatientGroup.style.display = 'none';
                searchPractitionerGroup.style.display = 'none';
                newPatientForm.style.display = 'none';
                newPractitionerForm.style.display = 'none';
                
                setStatus('å·²è¼‰å…¥æ€¥è¨ºç¯„ä¾‹è³‡æ–™', 'success');
                updateResourceStatus();
                
                // é‡æ–°è¼‰å…¥ç—…æ‚£å’Œé†«å¸«åˆ—è¡¨
                if (searchPatientGroup.style.display !== 'none') {
                    loadPatientOptions();
                }
                if (searchPractitionerGroup.style.display !== 'none') {
                    loadPractitionerOptions();
                }
            } catch (error) {
                setStatus(`è¼‰å…¥æ€¥è¨ºç¯„ä¾‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // å¾ Practitioner è³‡æºå–å¾—å§“å
        function getPractitionerName(practitioner) {
            if (practitioner.name && practitioner.name.length > 0) {
                const name = practitioner.name[0];
                if (name.text) return name.text;
                if (name.family && name.given) return `${name.family}${name.given.join('')}`;
                if (name.family) return name.family;
            }
            return 'é†«å¸«';
        }
        
        // å¾ Patient è³‡æºå–å¾—å§“å
        function getPatientName(patient) {
            if (patient.name && patient.name.length > 0) {
                const name = patient.name[0];
                if (name.text) return name.text;
                if (name.family && name.given) return `${name.family}${name.given.join('')}`;
                if (name.family) return name.family;
            }
            return 'ç—…æ‚£';
        }
        
        // åˆ‡æ›æ“ä½œæ¨¡å¼
        function toggleOperationMode() {
            if (opUpdate.checked) {
                requestIdGroup.style.display = 'block';
                document.getElementById('btnSubmit').innerHTML = '<i class="fas fa-edit"></i> æ›´æ–°è«‹æ±‚';
            } else {
                requestIdGroup.style.display = 'none';
                document.getElementById('btnSubmit').innerHTML = '<i class="fas fa-paper-plane"></i> æäº¤è«‹æ±‚';
            }
        }
        
        // è™•ç†è«‹æ±‚é¸æ“‡
        function handleRequestSelect() {
            const value = requestSelect.value;
            if (value && value !== 'search-request') {
                // è¼‰å…¥è«‹æ±‚è©³ç´°è³‡è¨Š
                loadRequestDetails(value);
            } else if (value === 'search-request') {
                searchRequestGroup.style.display = 'block';
            }
        }
        
        // è¼‰å…¥æˆ‘çš„è«‹æ±‚
        async function loadMyRequests() {
            if (!currentOrganization.id || !currentOrganization.verified) {
                setStatus('è«‹å…ˆé¸æ“‡çµ„ç¹”', 'error');
                return;
            }
            
            if (!currentPractitioner.id || !currentPractitioner.verified) {
                setStatus('è«‹å…ˆé¸æ“‡é†«å¸«', 'error');
                return;
            }
            
            try {
                setStatus('æ­£åœ¨è¼‰å…¥æˆ‘çš„è«‹æ±‚...', 'info');
                
                // æœå°‹ç•¶å‰é†«å¸«çš„ ServiceRequestï¼Œä¸”å±¬æ–¼ç•¶å‰çµ„ç¹”
                let url = `${FHIR_SERVER}ServiceRequest?`;
                
                // å¦‚æœæœ‰PractitionerRoleï¼Œä½¿ç”¨å®ƒä½œç‚ºrequester
                if (currentPractitioner.roleId) {
                    url += `requester=PractitionerRole/${currentPractitioner.roleId}`;
                } else {
                    url += `requester=Practitioner/${currentPractitioner.id}`;
                }
                
                url += `&performer=Organization/${currentOrganization.id}&_count=20&_sort=-_lastUpdated`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (response.ok && result.entry && result.entry.length > 0) {
                    displayRequestSearchResults(result.entry);
                    setStatus(`è¼‰å…¥ ${result.entry.length} å€‹è«‹æ±‚`, 'success');
                } else {
                    requestSearchResults.innerHTML = '<div class="search-result-item">æœªæ‰¾åˆ°è«‹æ±‚</div>';
                    setStatus('æœªæ‰¾åˆ°è«‹æ±‚', 'warning');
                }
            } catch (error) {
                setStatus(`è¼‰å…¥è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // é¡¯ç¤ºè«‹æ±‚æœå°‹çµæœ
        function displayRequestSearchResults(requests) {
            let html = '';
            
            requests.forEach((entry, index) => {
                const request = entry.resource;
                const requestId = request.id;
                const patientRef = request.subject?.reference?.split('/')[1] || 'æœªçŸ¥';
                const requestType = request.code?.text || 'æœªçŸ¥é¡å‹';
                const status = request.status || 'unknown';
                
                html += `
                    <div class="search-result-item" onclick="selectRequest('${requestId}')">
                        <div class="search-result-name">${requestType}</div>
                        <div class="search-result-id">ID: ${requestId} | ç—…æ‚£: ${patientRef} | ç‹€æ…‹: ${status}</div>
                    </div>
                `;
            });
            
            requestSearchResults.innerHTML = html;
        }
        
        // é¸æ“‡è«‹æ±‚
        function selectRequest(requestId) {
            requestSelect.value = requestId;
            loadRequestDetails(requestId);
            searchRequestGroup.style.display = 'none';
        }
        
        // è¼‰å…¥è«‹æ±‚è©³ç´°è³‡è¨Š
        async function loadRequestDetails(requestId) {
            try {
                setStatus(`æ­£åœ¨è¼‰å…¥è«‹æ±‚ ${requestId}...`, 'info');
                
                const response = await fetch(`${FHIR_SERVER}ServiceRequest/${requestId}`);
                
                if (response.ok) {
                    const request = await response.json();
                    
                    // æ›´æ–°è¡¨å–®å€¼
                    if (request.code?.text) {
                        // åŒ¹é…æœå‹™é¡å‹
                        const serviceText = request.code.text.toLowerCase();
                        if (serviceText.includes('è¡€æ¶²')) serviceType.value = 'lab-blood';
                        else if (serviceText.includes('å°¿æ¶²')) serviceType.value = 'lab-urine';
                        else if (serviceText.includes('xå…‰')) serviceType.value = 'imaging-xray';
                        else if (serviceText.includes('è¶…éŸ³æ³¢')) serviceType.value = 'imaging-ultrasound';
                        else if (serviceText.includes('é›»è…¦æ–·å±¤')) serviceType.value = 'imaging-ct';
                        else serviceType.value = 'consultation';
                    }
                    
                    if (request.priority) priority.value = request.priority;
                    if (request.note?.[0]?.text) clinicalNote.value = request.note[0].text;
                    
                    // æ›´æ–°ç—…æ‚£è³‡è¨Š
                    if (request.subject?.reference) {
                        const patientId = request.subject.reference.split('/')[1];
                        patientSelect.value = patientId;
                        checkPatient(patientId);
                    }
                    
                    // æ›´æ–°é†«å¸«è³‡è¨Š
                    if (request.requester?.reference) {
                        const requesterRef = request.requester.reference;
                        if (requesterRef.startsWith('Practitioner/')) {
                            const practitionerId = requesterRef.split('/')[1];
                            practitionerSelect.value = practitionerId;
                            checkPractitioner(practitionerId);
                        } else if (requesterRef.startsWith('PractitionerRole/')) {
                            // å¦‚æœæ˜¯PractitionerRoleï¼Œéœ€è¦æ‰¾åˆ°å°æ‡‰çš„Practitioner
                            const roleId = requesterRef.split('/')[1];
                            const roleResponse = await fetch(`${FHIR_SERVER}PractitionerRole/${roleId}`);
                            if (roleResponse.ok) {
                                const role = await roleResponse.json();
                                if (role.practitioner?.reference) {
                                    const practitionerId = role.practitioner.reference.split('/')[1];
                                    practitionerSelect.value = practitionerId;
                                    checkPractitioner(practitionerId);
                                    currentPractitioner.roleId = roleId;
                                }
                            }
                        }
                    }
                    
                    setStatus(`è«‹æ±‚ ${requestId} å·²è¼‰å…¥`, 'success');
                } else {
                    setStatus(`è¼‰å…¥è«‹æ±‚å¤±æ•—`, 'error');
                }
            } catch (error) {
                setStatus(`è¼‰å…¥è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // æäº¤è«‹æ±‚ - ä¿®æ­£ç‰ˆæœ¬ï¼Œç§»é™¤è‡ªå‹•èª¿ç”¨ searchRequests
        async function submitRequest() {
            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!currentPatient.id || !currentPatient.verified) {
                setStatus('è«‹é¸æ“‡æœ‰æ•ˆçš„ç—…æ‚£', 'error');
                return;
            }
            
            if (!currentPractitioner.id || !currentPractitioner.verified) {
                setStatus('è«‹é¸æ“‡æœ‰æ•ˆçš„é†«å¸«', 'error');
                return;
            }
            
            if (!serviceType.value) {
                setStatus('è«‹é¸æ“‡æœå‹™é¡å‹', 'error');
                return;
            }
            
            if (!priority.value) {
                setStatus('è«‹é¸æ“‡å„ªå…ˆç­‰ç´š', 'error');
                return;
            }
            
            if (!currentOrganization.id || !currentOrganization.verified) {
                setStatus('è«‹å…ˆé¸æ“‡çµ„ç¹”', 'error');
                return;
            }
            
            try {
                setStatus('æ­£åœ¨æäº¤æœå‹™è«‹æ±‚...', 'info');
                
                // å»ºç«‹ ServiceRequest è³‡æº
                const serviceTypeMap = {
                    'lab-blood': { code: '108252007', display: 'è¡€æ¶²æª¢é©—' },
                    'lab-urine': { code: '104177006', display: 'å°¿æ¶²æª¢é©—' },
                    'imaging-xray': { code: '16310003', display: 'Xå…‰æª¢æŸ¥' },
                    'imaging-ultrasound': { code: '163121009', display: 'è¶…éŸ³æ³¢æª¢æŸ¥' },
                    'imaging-ct': { code: '113091000', display: 'é›»è…¦æ–·å±¤æƒæ' },
                    'consultation': { code: '11429006', display: 'å°ˆç§‘æœƒè¨º' },
                    'procedure': { code: '387713003', display: 'è™•ç½®/æ‰‹è¡“' }
                };
                
                const serviceInfo = serviceTypeMap[serviceType.value] || { code: '11429006', display: 'å°ˆç§‘æœƒè¨º' };
                
                // æ±ºå®šæ“ä½œé¡å‹
                const isUpdate = opUpdate.checked && requestSelect.value && requestSelect.value !== 'search-request';
                const requestId = isUpdate ? requestSelect.value : 'servicerequest-' + Date.now().toString().slice(-6);
                
                // å»ºç«‹è«‹æ±‚è³‡æ–™
                const requestData = {
                    resourceType: "ServiceRequest",
                    id: requestId,
                    status: "active",
                    intent: "order",
                    priority: priority.value,
                    code: {
                        coding: [{
                            system: "http://snomed.info/sct",
                            code: serviceInfo.code,
                            display: serviceInfo.display
                        }]
                    },
                    subject: {
                        reference: `Patient/${currentPatient.id}`,
                        display: currentPatient.name
                    },
                    requester: {
                        reference: currentPractitioner.roleId ? `PractitionerRole/${currentPractitioner.roleId}` : `Practitioner/${currentPractitioner.id}`,
                        display: currentPractitioner.name
                    },
                    performer: [
                        {
                            reference: `Organization/${currentOrganization.id}`,
                            display: currentOrganization.name
                        }
                    ],
                    authoredOn: new Date().toISOString()
                };
                
                // æ·»åŠ è‡¨åºŠè¨»è¨˜ï¼ˆå¦‚æœæœ‰ï¼‰
                if (clinicalNote.value.trim()) {
                    requestData.note = [{
                        text: clinicalNote.value
                    }];
                }
                
                // ä½¿ç”¨ PUT æ–¹æ³•å»ºç«‹æˆ–æ›´æ–°è³‡æº
                const url = `${FHIR_SERVER}ServiceRequest/${requestId}`;
                
                console.log('ç™¼é€è«‹æ±‚åˆ°:', url);
                console.log('è«‹æ±‚è³‡æ–™:', JSON.stringify(requestData, null, 2));
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/fhir+json',
                        'Accept': 'application/fhir+json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('å›æ‡‰ç‹€æ…‹:', response.status);
                
                const result = await response.json();
                console.log('å›æ‡‰è³‡æ–™:', result);
                
                if (response.ok) {
                    const action = isUpdate ? 'æ›´æ–°' : 'å»ºç«‹';
                    setStatus(`æœå‹™è«‹æ±‚${action}æˆåŠŸï¼ID: ${requestId}`, 'success');
                    displayResult(result, `${action}æœå‹™è«‹æ±‚å›æ‡‰`);
                    
                    // å¦‚æœæ˜¯æ–°å¢è«‹æ±‚ï¼ŒåŠ å…¥æ­·å²
                    if (!isUpdate) {
                        requestHistory.push({
                            id: requestId,
                            patient: currentPatient.name,
                            practitioner: currentPractitioner.name,
                            type: serviceInfo.display,
                            priority: priority.value,
                            status: 'active',
                            date: new Date().toISOString()
                        });
                    }
                    
                    // é‡è¦ï¼šé€™è£¡ä¸å†è‡ªå‹•èª¿ç”¨ searchRequests()
                    // ä½¿ç”¨è€…å¯ä»¥æ‰‹å‹•é»æ“Š"æŸ¥è©¢è«‹æ±‚"ä¾†æŸ¥çœ‹æ–°å»ºç«‹çš„è«‹æ±‚
                    
                    // å¦‚æœæ˜¯æ›´æ–°æ¨¡å¼ï¼Œåˆ‡æ›å›å»ºç«‹æ¨¡å¼
                    if (isUpdate) {
                        opCreate.checked = true;
                        toggleOperationMode();
                        requestSelect.value = '';
                    }
                } else {
                    setStatus(`${isUpdate ? 'æ›´æ–°' : 'å»ºç«‹'}è«‹æ±‚å¤±æ•—: ${response.status} ${result.issue?.[0]?.details?.text || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                    displayResult(result, 'éŒ¯èª¤å›æ‡‰');
                }
            } catch (error) {
                console.error('æäº¤è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                setStatus(`éŒ¯èª¤: ${error.message}`, 'error');
                displayResult(`æäº¤è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'éŒ¯èª¤');
            }
        }
        
        // æŸ¥è©¢è«‹æ±‚ï¼ˆåªæŸ¥è©¢ç•¶å‰çµ„ç¹”çš„è«‹æ±‚ï¼‰
        async function searchRequests() {
            if (!currentOrganization.id || !currentOrganization.verified) {
                setStatus('è«‹å…ˆé¸æ“‡çµ„ç¹”', 'error');
                return;
            }
            
            try {
                setStatus('æ­£åœ¨æŸ¥è©¢è«‹æ±‚...', 'info');
                
                let url = `${FHIR_SERVER}ServiceRequest?performer=Organization/${currentOrganization.id}&_count=50&_sort=-_lastUpdated`;
                
                // æ·»åŠ ç¯©é¸æ¢ä»¶
                const filterPractitioner = document.getElementById('filterPractitioner').value;
                const filterPatient = document.getElementById('filterPatient').value;
                const filterStatus = document.getElementById('filterStatus').value;
                const filterPriority = document.getElementById('filterPriority').value;
                
                if (filterPractitioner === 'current' && currentPractitioner.id) {
                    if (currentPractitioner.roleId) {
                        url += `&requester=PractitionerRole/${currentPractitioner.roleId}`;
                    } else {
                        url += `&requester=Practitioner/${currentPractitioner.id}`;
                    }
                }
                
                if (filterPatient === 'current' && currentPatient.id) {
                    url += `&subject=Patient/${currentPatient.id}`;
                }
                
                if (filterStatus) {
                    url += `&status=${filterStatus}`;
                }
                
                if (filterPriority) {
                    url += `&priority=${filterPriority}`;
                }
                
                console.log('æŸ¥è©¢URL:', url);
                
                const response = await fetch(url);
                const result = await response.json();
                
                console.log('æŸ¥è©¢çµæœ:', result);
                
                if (response.ok && result.entry && result.entry.length > 0) {
                    // å„²å­˜æŸ¥è©¢çµæœ
                    currentRequests = result.entry;
                    
                    // è¨ˆç®—åˆ†é 
                    totalPages = Math.ceil(currentRequests.length / itemsPerPage);
                    currentPage = 1;
                    
                    // é¡¯ç¤ºåˆ†é æ§åˆ¶
                    paginationControls.style.display = 'flex';
                    
                    // é¡¯ç¤ºç¬¬ä¸€é 
                    displayCurrentPage();
                    
                    setStatus(`æ‰¾åˆ° ${currentRequests.length} å€‹è«‹æ±‚ï¼Œå…± ${totalPages} é `, 'success');
                } else {
                    currentRequests = [];
                    totalPages = 1;
                    currentPage = 1;
                    paginationControls.style.display = 'none';
                    requestsList.innerHTML = '<div class="no-requests"><i class="fas fa-inbox fa-2x" style="margin-bottom: 10px;"></i><p>æœªæ‰¾åˆ°è«‹æ±‚</p></div>';
                    setStatus('æœªæ‰¾åˆ°è«‹æ±‚', 'warning');
                }
            } catch (error) {
                setStatus(`æŸ¥è©¢è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                console.error('æŸ¥è©¢è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }
        
        // é¡¯ç¤ºç•¶å‰é çš„è«‹æ±‚
        function displayCurrentPage() {
            if (currentRequests.length === 0) {
                requestsList.innerHTML = '<div class="no-requests"><i class="fas fa-inbox fa-2x" style="margin-bottom: 10px;"></i><p>æœªæ‰¾åˆ°è«‹æ±‚</p></div>';
                return;
            }
            
            // è¨ˆç®—ç•¶å‰é çš„èµ·å§‹å’ŒçµæŸç´¢å¼•
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, currentRequests.length);
            const pageRequests = currentRequests.slice(startIndex, endIndex);
            
            let html = '';
            
            pageRequests.forEach((entry, index) => {
                const request = entry.resource;
                const requestId = request.id;
                const patientRef = request.subject?.reference?.split('/')[1] || 'æœªçŸ¥';
                const patientName = request.subject?.display || 'æœªçŸ¥ç—…æ‚£';
                const practitionerRef = request.requester?.reference?.split('/')[1] || 'æœªçŸ¥';
                const practitionerName = request.requester?.display || 'æœªçŸ¥é†«å¸«';
                const requestType = request.code?.text || request.code?.coding?.[0]?.display || 'æœªçŸ¥é¡å‹';
                const status = request.status || 'unknown';
                const priority = request.priority || 'routine';
                const authoredDate = request.authoredOn ? new Date(request.authoredOn).toLocaleString() : 'æœªçŸ¥æ™‚é–“';
                
                const statusClass = {
                    'active': 'status-active',
                    'completed': 'status-completed',
                    'cancelled': 'status-cancelled'
                }[status] || 'status-active';
                
                const priorityText = {
                    'routine': 'å¸¸è¦',
                    'urgent': 'ç·Šæ€¥',
                    'stat': 'æœ€å„ªå…ˆ'
                }[priority] || priority;
                
                const isSelected = selectedRequests.has(requestId);
                const selectedClass = isSelected ? 'selected' : '';
                const selectButtonText = isSelected ? 'å·²é¸' : 'é¸æ“‡';
                const selectButtonClass = isSelected ? 'btn-success' : 'btn-danger';
                
                html += `
                    <div class="request-item ${selectedClass}" id="request-${requestId}">
                        <div class="request-item-header">
                            <div class="request-id">${requestType}</div>
                            <div class="request-status ${statusClass}">${status}</div>
                        </div>
                        <div class="request-details">
                            <div class="detail-item">
                                <div class="detail-label">è«‹æ±‚ ID</div>
                                <div class="detail-value">${requestId}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">ç—…æ‚£</div>
                                <div class="detail-value">${patientName}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">é†«å¸«</div>
                                <div class="detail-value">${practitionerName}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">å„ªå…ˆç´š</div>
                                <div class="detail-value">${priorityText}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">å»ºç«‹æ™‚é–“</div>
                                <div class="detail-value">${authoredDate}</div>
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="btn-secondary btn-sm" onclick="viewRequestDetails('${requestId}')">
                                <i class="fas fa-eye"></i> æŸ¥çœ‹
                            </button>
                            <button class="btn-warning btn-sm" onclick="selectRequestForUpdate('${requestId}')">
                                <i class="fas fa-edit"></i> æ›´æ–°
                            </button>
                            <button class="${selectButtonClass} btn-sm" onclick="toggleRequestSelection('${requestId}')">
                                <i class="${isSelected ? 'fas fa-check-circle' : 'fas fa-check-square'}"></i> ${selectButtonText}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            requestsList.innerHTML = html;
            updateSelectedCount();
            updatePaginationControls();
        }
        
        // æ›´æ–°åˆ†é æ§åˆ¶
        function updatePaginationControls() {
            pageInfo.textContent = `ç¬¬ ${currentPage} é  / å…± ${totalPages} é `;
            
            btnFirstPage.disabled = currentPage === 1;
            btnPrevPage.disabled = currentPage === 1;
            btnNextPage.disabled = currentPage === totalPages;
            btnLastPage.disabled = currentPage === totalPages;
            
            // æ›´æ–°åˆ†é æŒ‰éˆ•æ¨£å¼
            const buttons = [btnFirstPage, btnPrevPage, btnNextPage, btnLastPage];
            buttons.forEach(btn => {
                if (btn.disabled) {
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }
        
        // å‰å¾€æŒ‡å®šé é¢
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayCurrentPage();
        }
        
        // æŸ¥çœ‹è«‹æ±‚è©³ç´°è³‡è¨Š
        async function viewRequestDetails(requestId) {
            try {
                const response = await fetch(`${FHIR_SERVER}ServiceRequest/${requestId}`);
                
                if (response.ok) {
                    const request = await response.json();
                    displayResult(request, `è«‹æ±‚ ${requestId} è©³ç´°è³‡è¨Š`);
                    setStatus(`å·²è¼‰å…¥è«‹æ±‚ ${requestId} è©³ç´°è³‡è¨Š`, 'success');
                } else {
                    setStatus(`è¼‰å…¥è«‹æ±‚è©³ç´°è³‡è¨Šå¤±æ•—`, 'error');
                }
            } catch (error) {
                setStatus(`è¼‰å…¥è«‹æ±‚è©³ç´°è³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // é¸æ“‡è«‹æ±‚é€²è¡Œæ›´æ–°
        function selectRequestForUpdate(requestId) {
            opUpdate.checked = true;
            toggleOperationMode();
            requestSelect.value = requestId;
            loadRequestDetails(requestId);
            setStatus(`å·²é¸æ“‡è«‹æ±‚ ${requestId} é€²è¡Œæ›´æ–°`, 'info');
        }
        
        // åˆ‡æ›è«‹æ±‚é¸æ“‡ç‹€æ…‹
        function toggleRequestSelection(requestId) {
            const requestElement = document.getElementById(`request-${requestId}`);
            
            if (selectedRequests.has(requestId)) {
                selectedRequests.delete(requestId);
                requestElement.classList.remove('selected');
            } else {
                selectedRequests.add(requestId);
                requestElement.classList.add('selected');
            }
            
            updateSelectedCount();
            
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—å’Œæ¨£å¼
            const button = requestElement.querySelector('.request-actions button:last-child');
            if (selectedRequests.has(requestId)) {
                button.innerHTML = '<i class="fas fa-check-circle"></i> å·²é¸';
                button.className = 'btn-success btn-sm';
            } else {
                button.innerHTML = '<i class="fas fa-check-square"></i> é¸æ“‡';
                button.className = 'btn-danger btn-sm';
            }
        }
        
        // åˆªé™¤é¸ä¸­çš„è«‹æ±‚
        async function deleteSelectedRequests() {
            if (selectedRequests.size === 0) {
                setStatus('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è«‹æ±‚ï¼ˆé»æ“Š"é¸æ“‡"æŒ‰éˆ•æ¨™è¨˜è«‹æ±‚ï¼‰', 'warning');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ ${selectedRequests.size} å€‹é¸ä¸­çš„è«‹æ±‚å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                return;
            }
            
            try {
                setStatus('æ­£åœ¨åˆªé™¤é¸ä¸­çš„è«‹æ±‚...', 'info');
                let successCount = 0;
                let failCount = 0;
                
                // å°‡ Set è½‰æ›ç‚ºé™£åˆ—ä»¥ä¾¿è™•ç†
                const requestsArray = Array.from(selectedRequests);
                
                for (const requestId of requestsArray) {
                    try {
                        // ä½¿ç”¨ DELETE æ–¹æ³•åˆªé™¤è³‡æº
                        const response = await fetch(`${FHIR_SERVER}ServiceRequest/${requestId}`, {
                            method: 'DELETE',
                            headers: { 
                                'Content-Type': 'application/fhir+json',
                                'Accept': 'application/fhir+json'
                            }
                        });
                        
                        if (response.ok) {
                            successCount++;
                            
                            // å¾é¸æ“‡é›†ä¸­ç§»é™¤
                            selectedRequests.delete(requestId);
                            
                            // å¾ç•¶å‰è«‹æ±‚åˆ—è¡¨ä¸­ç§»é™¤
                            const index = currentRequests.findIndex(entry => entry.resource.id === requestId);
                            if (index !== -1) {
                                currentRequests.splice(index, 1);
                            }
                            
                        } else {
                            const errorResult = await response.json();
                            console.error(`åˆªé™¤è«‹æ±‚ ${requestId} å¤±æ•—:`, errorResult);
                            failCount++;
                        }
                    } catch (error) {
                        console.error(`è™•ç†è«‹æ±‚ ${requestId} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                        failCount++;
                    }
                }
                
                // æ›´æ–°é¸ä¸­æ•¸é‡
                updateSelectedCount();
                
                // é¡¯ç¤ºæœ€çµ‚çµæœ
                if (successCount > 0) {
                    setStatus(`æˆåŠŸåˆªé™¤ ${successCount} å€‹è«‹æ±‚${failCount > 0 ? `ï¼Œå¤±æ•— ${failCount} å€‹` : ''}`, 'success');
                    
                    // é‡æ–°è¨ˆç®—åˆ†é 
                    totalPages = Math.ceil(currentRequests.length / itemsPerPage);
                    if (currentPage > totalPages && totalPages > 0) {
                        currentPage = totalPages;
                    } else if (totalPages === 0) {
                        currentPage = 1;
                    }
                    
                    // é‡æ–°é¡¯ç¤ºç•¶å‰é 
                    displayCurrentPage();
                } else {
                    setStatus(`åˆªé™¤è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ç²å–è©³ç´°ä¿¡æ¯`, 'error');
                }
                
            } catch (error) {
                setStatus(`åˆªé™¤è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                console.error('åˆªé™¤é¸ä¸­è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }
        
        // é¡¯ç¤ºçµæœ
        function displayResult(result, title = 'çµæœ') {
            try {
                if (typeof result === 'object') {
                    resultContent.textContent = JSON.stringify(result, null, 2);
                } else {
                    resultContent.textContent = result;
                }
            } catch (e) {
                resultContent.textContent = result;
            }
        }
        
        // åˆ‡æ› JSON é¡¯ç¤ºæ–¹å¼
        function toggleJsonView(mode) {
            const btnRaw = document.getElementById('btnRawJson');
            const btnFormatted = document.getElementById('btnFormattedJson');
            
            if (mode === 'raw') {
                btnRaw.classList.add('active');
                btnFormatted.classList.remove('active');
                
                try {
                    const json = JSON.parse(resultContent.textContent);
                    resultContent.textContent = JSON.stringify(json);
                } catch (e) {
                    // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œä¿æŒåŸæ¨£
                }
            } else {
                btnRaw.classList.remove('active');
                btnFormatted.classList.add('active');
                
                try {
                    const json = JSON.parse(resultContent.textContent);
                    resultContent.textContent = JSON.stringify(json, null, 2);
                } catch (e) {
                    // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œä¿æŒåŸæ¨£
                }
            }
        }
        
        // JSON æ¨¡å¼ - å»ºç«‹è³‡æº
        async function jsonCreate() {
            const resourceType = document.getElementById('resourceType').value;
            const resourceId = document.getElementById('resourceId').value.trim();
            const jsonText = document.getElementById('resourceJson').value;
            
            if (!resourceType) {
                setStatus('è«‹é¸æ“‡è³‡æºé¡å‹', 'error');
                return;
            }
            
            if (!jsonText) {
                setStatus('è«‹è¼¸å…¥ JSON å…§å®¹', 'error');
                return;
            }
            
            try {
                const jsonData = JSON.parse(jsonText);
                jsonData.resourceType = resourceType;
                
                if (resourceId) {
                    jsonData.id = resourceId;
                }
                
                // å¦‚æœæ˜¯å»ºç«‹çµ„ç¹”ç›¸é—œè³‡æºï¼Œè‡ªå‹•æ·»åŠ çµ„ç¹”æ¨™è¨˜
                if (resourceType === 'Patient' && currentOrganization.id) {
                    if (!jsonData.meta) jsonData.meta = {};
                    if (!jsonData.meta.tag) jsonData.meta.tag = [];
                    jsonData.meta.tag.push({
                        system: "http://example.com/organization",
                        code: currentOrganization.id
                    });
                }
                
                const url = resourceId ? `${FHIR_SERVER}${resourceType}/${resourceId}` : `${FHIR_SERVER}${resourceType}`;
                const method = resourceId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/fhir+json',
                        'Accept': 'application/fhir+json'
                    },
                    body: JSON.stringify(jsonData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    setStatus(`è³‡æº${resourceId ? 'æ›´æ–°' : 'å»ºç«‹'}æˆåŠŸï¼`, 'success');
                    displayResult(result, `${resourceId ? 'æ›´æ–°' : 'å»ºç«‹'}å›æ‡‰`);
                } else {
                    setStatus(`${resourceId ? 'æ›´æ–°' : 'å»ºç«‹'}å¤±æ•—: ${result.issue?.[0]?.details?.text || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                    displayResult(result, 'éŒ¯èª¤å›æ‡‰');
                }
            } catch (error) {
                setStatus(`éŒ¯èª¤: ${error.message}`, 'error');
                displayResult(`è™•ç† JSON æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'éŒ¯èª¤');
            }
        }
        
        // JSON æ¨¡å¼ - è®€å–è³‡æº
        async function jsonRead() {
            const resourceType = document.getElementById('resourceType').value;
            const resourceId = document.getElementById('resourceId').value.trim();
            
            if (!resourceType || !resourceId) {
                setStatus('è«‹é¸æ“‡è³‡æºé¡å‹å’Œè¼¸å…¥è³‡æº ID', 'error');
                return;
            }
            
            try {
                setStatus(`æ­£åœ¨è®€å– ${resourceType}/${resourceId}...`, 'info');
                
                const response = await fetch(`${FHIR_SERVER}${resourceType}/${resourceId}`);
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('resourceJson').value = JSON.stringify(result, null, 2);
                    setStatus(`è³‡æºè®€å–æˆåŠŸï¼`, 'success');
                    displayResult(result, `è®€å–å›æ‡‰`);
                } else {
                    setStatus(`è®€å–å¤±æ•—: ${result.issue?.[0]?.details?.text || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                    displayResult(result, 'éŒ¯èª¤å›æ‡‰');
                }
            } catch (error) {
                setStatus(`éŒ¯èª¤: ${error.message}`, 'error');
                displayResult(`è®€å–è³‡æºæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'éŒ¯èª¤');
            }
        }
        
        // JSON æ¨¡å¼ - æ›´æ–°è³‡æº
        async function jsonUpdate() {
            // èˆ‡å»ºç«‹ç›¸åŒé‚è¼¯ï¼Œå› ç‚ºåœ¨ FHIR ä¸­ PUT æ—¢æ˜¯å»ºç«‹ä¹Ÿæ˜¯æ›´æ–°
            jsonCreate();
        }
        
        // JSON æ¨¡å¼ - åˆªé™¤è³‡æº
        async function jsonDelete() {
            const resourceType = document.getElementById('resourceType').value;
            const resourceId = document.getElementById('resourceId').value.trim();
            
            if (!resourceType || !resourceId) {
                setStatus('è«‹é¸æ“‡è³‡æºé¡å‹å’Œè¼¸å…¥è³‡æº ID', 'error');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${resourceType}/${resourceId} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                setStatus(`æ­£åœ¨åˆªé™¤ ${resourceType}/${resourceId}...`, 'info');
                
                const response = await fetch(`${FHIR_SERVER}${resourceType}/${resourceId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    setStatus(`è³‡æºåˆªé™¤æˆåŠŸï¼`, 'success');
                    displayResult({ success: true, message: `å·²åˆªé™¤ ${resourceType}/${resourceId}` }, 'åˆªé™¤å›æ‡‰');
                    
                    // æ¸…ç©º JSON ç·¨è¼¯å€
                    document.getElementById('resourceJson').value = '';
                } else {
                    const result = await response.json();
                    setStatus(`åˆªé™¤å¤±æ•—: ${result.issue?.[0]?.details?.text || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                    displayResult(result, 'éŒ¯èª¤å›æ‡‰');
                }
            } catch (error) {
                setStatus(`éŒ¯èª¤: ${error.message}`, 'error');
                displayResult(`åˆªé™¤è³‡æºæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'éŒ¯èª¤');
            }
        }
        
        // ç‚ºå…¨åŸŸå‡½æ•¸è¨­å®šåˆ¥å
        window.selectRequest = selectRequest;
        window.viewRequestDetails = viewRequestDetails;
        window.selectRequestForUpdate = selectRequestForUpdate;
        window.toggleRequestSelection = toggleRequestSelection;
    </script>
</body>
</html>
